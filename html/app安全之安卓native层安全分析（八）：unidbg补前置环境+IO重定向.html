<html>
 <head>
  <title>
   app安全之安卓native层安全分析（八）：unidbg补前置环境+IO重定向
  </title>
  <link data-noprefix="" href="prism.css" rel="stylesheet">
  <style>
   a{
    color: black;
    text-decoration: none;
}
a:hover{
    color: blue;
}
ul{
    list-style: none;
}
#catalogue {
    top: 10px;
    right: 10px;
    padding: 5px 10px;
    position: absolute;
    border: 1px solid blue;
    background-color: white;
}
  </style>
 </head>
 <body>
  <h1>
   <a>
    app安全之安卓native层安全分析（八）：unidbg补前置环境+IO重定向
   </a>
  </h1>
  <ul id="catalogue">
   <li title="返回目录">
    <a href="/html">
     返回目录
    </a>
   </li>
   <li title="前言">
    <a href="#user-content-前言">
     前言
    </a>
   </li>
   <li title="分析">
    <a href="#user-content-分析">
     分析
    </a>
   </li>
   <ul>
    <li title="1.静态分析">
     <a href="#user-content-1静态分析">
      1.静态分析
     </a>
    </li>
    <li title="2.frida动态调试">
     <a href="#user-content-2frida动态调试">
      2.frida动态调试
     </a>
    </li>
   </ul>
   <li title="ida调试">
    <a href="#user-content-ida调试">
     ida调试
    </a>
   </li>
   <li title="unidbg调试">
    <a href="#user-content-unidbg调试">
     unidbg调试
    </a>
   </li>
   <ul>
    <li title="1.搭架子">
     <a href="#user-content-1搭架子">
      1.搭架子
     </a>
    </li>
    <li title="2.调用">
     <a href="#user-content-2调用">
      2.调用
     </a>
    </li>
    <li title="3.解决问题">
     <a href="#user-content-3解决问题">
      3.解决问题
     </a>
    </li>
   </ul>
   <li title="知识点总结">
    <a href="#user-content-知识点总结">
     知识点总结
    </a>
   </li>
  </ul>
  <h2>
   <a aria-hidden="true" class="anchor" href="#前言" id="user-content-前言">
    <span aria-hidden="true" class="octicon octicon-link">
    </span>
   </a>
   前言
  </h2>
  <p>
   继续跟着龙哥的unidbg学习：
   <a href="https://blog.csdn.net/qq_38851536/article/details/118000259?spm=1001.2014.3001.5502" rel="nofollow" title="SO逆向入门实战教程七：main_unidbg 重定向_白龙~的博客-CSDN博客">
    SO逆向入门实战教程七：main_unidbg 重定向_白龙~的博客-CSDN博客
   </a>
  </p>
  <p>
   还是那句，我会借鉴龙哥的文章，以一个初学者的角度，加上自己的理解，把内容丰富一下，尽量做到不在龙哥的基础上画蛇添足。感谢观看的朋友。
  </p>
  <h2>
   <a aria-hidden="true" class="anchor" href="#分析" id="user-content-分析">
    <span aria-hidden="true" class="octicon octicon-link">
    </span>
   </a>
   分析
  </h2>
  <p>
   首先，抓个包
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/10c8fdeed770adb41c8272feeaed4518.png" style="max-width: 100%;">
  </p>
  <p>
   里面这个mtgsig就是该app很经典的加密参数了，siua参数后续有时间就分析，没有就算了。本篇文章的重点是mtgsig.
  </p>
  <h3>
   <a aria-hidden="true" class="anchor" href="#1静态分析" id="user-content-1静态分析">
    <span aria-hidden="true" class="octicon octicon-link">
    </span>
   </a>
   1.静态分析
  </h3>
  <p>
   jadx分析，一搜：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/2587a099659715c19f56a2480f554db9.png" style="max-width: 100%;">
  </p>
  <p>
   发现其实并不多。
  </p>
  <p>
   就拿这几个类进行hook，看看哪些方法被调用了就行了，没花多久时间，就找到这里：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/15d1f17ddff3e3822f5130f414ca348d.png" style="max-width: 100%;">
  </p>
  <blockquote>
   <p>
    com.xxxxx.plugin.sign.core.CandyPreprocessor.makeHeader(Uri$Builder) String
   </p>
  </blockquote>
  <p>
   再跟一下：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/3b0ee794930cc659cda7fea4de7b76e4.png" style="max-width: 100%;">
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/bda79786e6d3cb813becaba65f3e1902.png" style="max-width: 100%;">
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/6f66b8f399079cff3ada3dc4bbbf6612.png" style="max-width: 100%;">
  </p>
  <p>
   这个main就是我们要的部位了。我们知道，第一个int参数，其实都写死了，就是203
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/c7e0e2918a4f488d91c80dd5bbe2ae81.png" style="max-width: 100%;">
  </p>
  <p>
   第二个是一个对象数组
  </p>
  <p>
   hook下这两个方法，main的地方参数中间有个byte[]没有打印出来
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/d36d60f121086d2abed6510f7d0342a0.png" style="max-width: 100%;">
  </p>
  <h3>
   <a aria-hidden="true" class="anchor" href="#2frida动态调试" id="user-content-2frida动态调试">
    <span aria-hidden="true" class="octicon octicon-link">
    </span>
   </a>
   2.frida动态调试
  </h3>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/7f399740b203a9f7c027b5cf0b829a17.png" style="max-width: 100%;">
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/1ca12414e4537aba5a500ee43f8fd485.png" style="max-width: 100%;">
  </p>
  <p>
   所以这个byte[]就是个 请求方式&nbsp; url的path&nbsp; 子路径
  </p>
  <p>
   好了，入参大概都知道了
  </p>
  <h2>
   <a aria-hidden="true" class="anchor" href="#ida调试" id="user-content-ida调试">
    <span aria-hidden="true" class="octicon octicon-link">
    </span>
   </a>
   ida调试
  </h2>
  <p>
   调试之前，得找找他加载的是哪个so文件
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/5c41a8787867c04e866321acf4849e93.png" style="max-width: 100%;">
  </p>
  <p>
   这静态看代码，看了半天，愣是没看出来哪里用了system.loadlibrary。
  </p>
  <p>
   用这个grep找到的是这个so，其实并不是
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/ebbf8c047d97b350637565890a656284.png" style="max-width: 100%;">
  </p>
  <p>
   这里继续用yang神的hook_RegisterNative.js，一顿输出，直接找到这个so:
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/8ef6f381e0ad52767eb209f5ff5ff585.png" style="max-width: 100%;">
  </p>
  <p>
   很nice。
  </p>
  <p>
   卧槽，跑完直接把我手机干关机了。有点6
  </p>
  <p>
   接下来打开ida看看，导出表都不用看了
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/7e362857c2e775b660bc373c850751a2.png" style="max-width: 100%;">
  </p>
  <p>
   方法也看不到啊，上面用hook_RegisterNative已经hook到位置了，直接定位过去就行
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/3e3ea1a14a5c80dec77cb9ab01525079.png" style="max-width: 100%;">
  </p>
  <p>
   结果就是解析异常了。
  </p>
  <h2>
   <a aria-hidden="true" class="anchor" href="#unidbg调试" id="user-content-unidbg调试">
    <span aria-hidden="true" class="octicon octicon-link">
    </span>
   </a>
   unidbg调试
  </h2>
  <p>
   那直接unidbg调试吧
  </p>
  <h3>
   <a aria-hidden="true" class="anchor" href="#1搭架子" id="user-content-1搭架子">
    <span aria-hidden="true" class="octicon octicon-link">
    </span>
   </a>
   1.搭架子
  </h3>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/999ef16bc055208987bcbae1b1ed316b.png" style="max-width: 100%;">
  </p>
  <p>
   跑起来，好像没啥问题 ，main也有了。
  </p>
  <h3>
   <a aria-hidden="true" class="anchor" href="#2调用" id="user-content-2调用">
    <span aria-hidden="true" class="octicon octicon-link">
    </span>
   </a>
   2.调用
  </h3>
  <p>
   那么直接调用吧，首先把之前hook到的数据，传递进去
  </p>
  <p>
   上面需要的都有hook了，
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/c903f95278a304be3d4c879474ad7793.png" style="max-width: 100%;">
  </p>
  <p>
   现在就差这个key，往上找找：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/05afb18a71daf8036e0759af74158ba8.png" style="max-width: 100%;">
  </p>
  <p>
   hook下，等会儿，还hook啥呀，前面已经有了，就是这个9b69xxxx，思路不能乱，慢慢来
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/261195063b51f2a32ad854b65a2243c8.png" style="max-width: 100%;">
  </p>
  <p>
   开始调用，结果如下：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/03ecf5f485211e19f98bd0872fd6c0f7.png" style="max-width: 100%;">
  </p>
  <p>
   尴尬，报错的意思是这个指针结果是一个空指针。根据龙哥的博客，应该是上下文缺失。jnitrace也可以发现。
  </p>
  <h3>
   <a aria-hidden="true" class="anchor" href="#3解决问题" id="user-content-3解决问题">
    <span aria-hidden="true" class="octicon octicon-link">
    </span>
   </a>
   3.解决问题
  </h3>
  <p>
   再来看看，这个main的调用实例
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/d32415a99c34127745fdf60599ffaa42.png" style="max-width: 100%;">
  </p>
  <p>
   有这么多
  </p>
  <p>
   用fridahook下这些
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/66a54cbaa02b4cd2c9f81c7a9c1451a3.png" style="max-width: 100%;">
  </p>
  <p>
   发现，果然是了，刚开始调用，还是null，然后再次调用，就有值了。
  </p>
  <p>
   再来，把入参打印一下：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/d7420c96dc4eceba86e2f862121afceb.png" style="max-width: 100%;">
  </p>
  <p>
   看来第一次是111，也就是代码的这里：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/522e289ec83503c221ceb36343e2ca30.png" style="max-width: 100%;">
  </p>
  <p>
   这个好像还算简单。
  </p>
  <p>
   补一下这里的前置条件，然后执行：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/53470d295d0491f4a736fb4dbcd85357.png" style="max-width: 100%;">
  </p>
  <p>
   补下这个环境，但是这个是啥呢，直接用firda hook可知如下：
  </p>
  <p>
   因为他是static
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/4d20baf2e9ac3de0f887180edebcfbdb.png" style="max-width: 100%;">
  </p>
  <p>
   那么直接调用
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/870ec3c0653785442e0832df9755f7d5.png" style="max-width: 100%;">
  </p>
  <p>
   补完执行：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/f6f3c89bf300e50e576399962fc219d7.png" style="max-width: 100%;">
  </p>
  <p>
   又来一个新的，同样操作
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/1bd988af43835feb24c8dda4cbfb32a1.png" style="max-width: 100%;">
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/7d56f415f98902ab60b2e730a1192e97.png" style="max-width: 100%;">
  </p>
  <p>
   还有报错，
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/1eba3cdf41cecfbcf81b8419ac22461c.png" style="max-width: 100%;">
  </p>
  <p>
   继续
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/55d29c2df85fdcbf59f6ea7cffe64a32.png" style="max-width: 100%;">
  </p>
  <p>
   卧槽，还有报错，而且这个报错，龙哥的博客好像没有这个，我手机是米10，安卓12，估计有啥不一样
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/9e126a14437bbf1c0f55c2faefff6d31.png" style="max-width: 100%;">
  </p>
  <p>
   问题不大，他既然要返回一个i，也就是整形，那直接这么补，然后执行：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/4a0c583a9d69dde108908f0176ed0835.png" style="max-width: 100%;">
  </p>
  <p>
   说白了这个就是要获取当前的进程apk的路径，继续补
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/5a9a82d4ab4d4872279bfd83be1ba955.png" style="max-width: 100%;">
  </p>
  <p>
   没啥可说的，继续补：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/01a6b92929a8067570510f495d843d4f.png" style="max-width: 100%;">
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/512c6134985da9d87d00dbce7e91f6b5.png" style="max-width: 100%;">
  </p>
  <p>
   继续
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/973026324259fedddae791b674fc7e4c.png" style="max-width: 100%;">
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/6b5f46993e1aeab3c10252d2919ec9f9.png" style="max-width: 100%;">
  </p>
  <p>
   继续
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/6dbd5dcd5ef49599cba1b51200e6bdd5.png" style="max-width: 100%;">
  </p>
  <p>
   好了，终于不报错了，但是结果并没有被打印出来
  </p>
  <p>
   仔细看这里，根据龙哥的博客，意思是这里做了文件读取操作，但是-100，好像读取异常了
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/51f77b7845814235a6e810d9535afbb6.png" style="max-width: 100%;">
  </p>
  <p>
   这时候有两种方案解决这个
  </p>
  <ul>
   <li>
    到unidbg目录，把apk放进去，用这个文件src/main/java/com/github/unidbg/file/BaseFileSystem.java获取当前程序路径
   </li>
   <li>
    还可以用代码的方式进行操作，设置io重定向，把访问的路径放到我们指定的路径即可
   </li>
  </ul>
  <p>
   这里我用重定向的方式：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/86cd99e34b3306a5f4839ecf56dc6708.png" style="max-width: 100%;">
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/41b84dd61add728764d244ade4d39450.png" style="max-width: 100%;">
  </p>
  <p>
   然后执行：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/5afbcf082e0feb8ecf69d4b234ca9acc.png" style="max-width: 100%;">
  </p>
  <p>
   继续补
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/79dfc840d6c126bf359877d726f28802.png" style="max-width: 100%;">
  </p>
  <p>
   但这里出现了问题，这里是一个空，尴尬，查看用例：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/12555699b47abf3490e5c01270cf1e8f.png" style="max-width: 100%;">
  </p>
  <p>
   就这里做了赋值
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/340c39ab9362d361b005aaa08e31d992.png" style="max-width: 100%;">
  </p>
  <p>
   想hook一下，结果hook不到，尴尬，但是那边确实看到是空，龙哥的博客是有数据的，不重要，遵从内心，补一个空，执行看看：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/ed1f1eeaa979919ff4f1f262ccea8a73.png" style="max-width: 100%;">
  </p>
  <p>
   唉，结果有了，好像结果数据有点不对，最后是一个dvmobject，那就跟前面的文章一样了，转一下，打印下
  </p>
  <p>
   这两个方式都可以：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/f99a96c17941649104c44eae7d51789d.png" style="max-width: 100%;">
  </p>
  <p>
   这个结果能不能用呢？
  </p>
  <p>
   重新抓个包，然后替换下试试：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/7a73ac987bbf37ba4a482ad379e392e1.png" style="max-width: 100%;">
  </p>
  <p>
   ok，果然可以。很nice
  </p>
  <p>
   代码
  </p>
  <pre class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>sankuai</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span></span><span class="token class-name">AndroidEmulator</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span></span><span class="token class-name">Emulator</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span></span><span class="token class-name">Module</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span>file<span class="token punctuation">.</span></span><span class="token class-name">FileResult</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span>file<span class="token punctuation">.</span></span><span class="token class-name">IOResolver</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span>linux<span class="token punctuation">.</span>android<span class="token punctuation">.</span></span><span class="token class-name">AndroidEmulatorBuilder</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span>linux<span class="token punctuation">.</span>android<span class="token punctuation">.</span></span><span class="token class-name">AndroidResolver</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span>linux<span class="token punctuation">.</span>android<span class="token punctuation">.</span>dvm<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span>linux<span class="token punctuation">.</span>android<span class="token punctuation">.</span>dvm<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Binder</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span>linux<span class="token punctuation">.</span>android<span class="token punctuation">.</span>dvm<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">ServiceManager</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span>linux<span class="token punctuation">.</span>android<span class="token punctuation">.</span>dvm<span class="token punctuation">.</span>array<span class="token punctuation">.</span></span><span class="token class-name">ArrayObject</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span>linux<span class="token punctuation">.</span>android<span class="token punctuation">.</span>dvm<span class="token punctuation">.</span>array<span class="token punctuation">.</span></span><span class="token class-name">ByteArray</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span>linux<span class="token punctuation">.</span>android<span class="token punctuation">.</span>dvm<span class="token punctuation">.</span>wrapper<span class="token punctuation">.</span></span><span class="token class-name">DvmInteger</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span>linux<span class="token punctuation">.</span>file<span class="token punctuation">.</span></span><span class="token class-name">SimpleFileIO</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span>memory<span class="token punctuation">.</span></span><span class="token class-name">Memory</span></span><span class="token punctuation">;</span>


<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ByteArrayInputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">File</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">UnsupportedEncodingException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>charset<span class="token punctuation">.</span></span><span class="token class-name">StandardCharsets</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span><span class="token class-name">MessageDigest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span><span class="token class-name">NoSuchAlgorithmException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span>cert<span class="token punctuation">.</span></span><span class="token class-name">CertificateException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span>cert<span class="token punctuation">.</span></span><span class="token class-name">CertificateFactory</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Locale</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> meituan <span class="token keyword">extends</span> <span class="token class-name">AbstractJni</span> <span class="token keyword">implements</span> <span class="token class-name">IOResolver</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AndroidEmulator</span> emulator<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">VM</span> vm<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Module</span> <span class="token keyword">module</span><span class="token punctuation">;</span>

    <span class="token function">meituan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 创建模拟器实例,进程名建议依照实际进程名填写，可以规避针对进程名的校验</span>
        emulator <span class="token operator">=</span> <span class="token class-name">AndroidEmulatorBuilder</span><span class="token punctuation">.</span><span class="token function">for32Bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setProcessName</span><span class="token punctuation">(</span><span class="token string">"com.sankuai.meituan"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取模拟器的内存操作接口</span>
        <span class="token keyword">final</span> <span class="token class-name">Memory</span> memory <span class="token operator">=</span> emulator<span class="token punctuation">.</span><span class="token function">getMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        emulator.getSyscallHandler().setEnableThreadDispatcher(true);</span>
        <span class="token comment">// 设置系统类库解析</span>
        memory<span class="token punctuation">.</span><span class="token function">setLibraryResolver</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AndroidResolver</span><span class="token punctuation">(</span><span class="token number">23</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建Android虚拟机,传入APK，Unidbg可以替我们做部分签名校验的工作</span>
        vm <span class="token operator">=</span> emulator<span class="token punctuation">.</span><span class="token function">createDalvikVM</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"unidbg-android\\src\\test\\java\\com\\xxx\\xxx.apk"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 加载目标SO</span>
<span class="token comment">//        DalvikModule dm = vm.loadLibrary(new File("unidbg-android\\src\\test\\java\\com\\xxxx\\libmtguard.so"), true); // 加载so到虚拟内存</span>

        emulator<span class="token punctuation">.</span><span class="token function">getSyscallHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addIOResolver</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        vm<span class="token punctuation">.</span><span class="token function">setVerbose</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置是否打印Jni调用细节</span>
        <span class="token class-name">DalvikModule</span> dm <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"E:\\work\\myproject\\unidbg\\unidbg-android\\src\\test\\java\\com\\xxxx\\libmtguard.so"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment">//获取本SO模块的句柄,后续需要用它</span>
        <span class="token keyword">module</span> <span class="token operator">=</span> dm<span class="token punctuation">.</span><span class="token function">getModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        vm<span class="token punctuation">.</span><span class="token function">setJni</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置JNI</span>
        vm<span class="token punctuation">.</span><span class="token function">setVerbose</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 打印日志</span>
        dm<span class="token punctuation">.</span><span class="token function">callJNI_OnLoad</span><span class="token punctuation">(</span>emulator<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用JNI OnLoad</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">DvmObject</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">callStaticObjectMethodV</span><span class="token punctuation">(</span><span class="token class-name">BaseVM</span> vm<span class="token punctuation">,</span> <span class="token class-name">DvmClass</span> dvmClass<span class="token punctuation">,</span> <span class="token class-name">String</span> signature<span class="token punctuation">,</span> <span class="token class-name">VaList</span> vaList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>signature<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token string">"com/meituan/android/common/mtguard/NBridge-&gt;getPicName()Ljava/lang/String;"</span><span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">StringObject</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">"ms_com.xxx.xxx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string">"com/meituan/android/common/mtguard/NBridge-&gt;getSecName()Ljava/lang/String;"</span><span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">StringObject</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">"ppd_com.xxx.xxx.xbt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string">"com/xxxx/android/common/mtguard/NBridge-&gt;getAppContext()Landroid/content/Context;"</span><span class="token operator">:</span>
                <span class="token keyword">return</span> vm<span class="token punctuation">.</span><span class="token function">resolveClass</span><span class="token punctuation">(</span><span class="token string">"android/content/Context"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newObject</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string">"com/xxxx/android/common/mtguard/NBridge-&gt;getMtgVN()Ljava/lang/String;"</span><span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">StringObject</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">"4.4.7.3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string">"com/xxx/android/common/mtguard/NBridge-&gt;getDfpId()Ljava/lang/String;"</span><span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">StringObject</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">callStaticObjectMethodV</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> dvmClass<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> vaList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">DvmObject</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">newObjectV</span><span class="token punctuation">(</span><span class="token class-name">BaseVM</span> vm<span class="token punctuation">,</span> <span class="token class-name">DvmClass</span> dvmClass<span class="token punctuation">,</span> <span class="token class-name">String</span> signature<span class="token punctuation">,</span> <span class="token class-name">VaList</span> vaList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>signature<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token string">"java/lang/Integer-&gt;&lt;init&gt;(I)V"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> input <span class="token operator">=</span> vaList<span class="token punctuation">.</span><span class="token function">getIntArg</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> vm<span class="token punctuation">.</span><span class="token function">resolveClass</span><span class="token punctuation">(</span><span class="token string">"java/lang/Integer"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newObject</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">newObjectV</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> dvmClass<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> vaList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getStaticIntField</span><span class="token punctuation">(</span><span class="token class-name">BaseVM</span> vm<span class="token punctuation">,</span> <span class="token class-name">DvmClass</span> dvmClass<span class="token punctuation">,</span> <span class="token class-name">String</span> signature<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>signature<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token string">"android/content/pm/PackageManager-&gt;GET_SIGNATURES:I"</span><span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getStaticIntField</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> dvmClass<span class="token punctuation">,</span> signature<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getIntField</span><span class="token punctuation">(</span><span class="token class-name">BaseVM</span> vm<span class="token punctuation">,</span> <span class="token class-name">DvmObject</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> dvmObject<span class="token punctuation">,</span> <span class="token class-name">String</span> signature<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>signature<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token string">"android/content/pm/PackageInfo-&gt;versionCode:I"</span><span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getIntField</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> dvmObject<span class="token punctuation">,</span> signature<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">DvmObject</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">callObjectMethodV</span><span class="token punctuation">(</span><span class="token class-name">BaseVM</span> vm<span class="token punctuation">,</span> <span class="token class-name">DvmObject</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> dvmObject<span class="token punctuation">,</span> <span class="token class-name">String</span> signature<span class="token punctuation">,</span> <span class="token class-name">VaList</span> vaList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>signature<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token string">"android/content/Context-&gt;getPackageCodePath()Ljava/lang/String;"</span><span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">StringObject</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">"/data/app/com.xxx.xxx-TEfTAIBttUmUzuVbwRK1DQ==/base.apk"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">callObjectMethodV</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> dvmObject<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> vaList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        meituan test <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">meituan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        test<span class="token punctuation">.</span><span class="token function">callMain111</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>test<span class="token punctuation">.</span><span class="token function">getSign</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">callMain111</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">getJNIEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// arg1</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//arg2</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">111</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//arg3</span>
        <span class="token class-name">DvmObject</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> obj <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">resolveClass</span><span class="token punctuation">(</span><span class="token string">"java/lang/object"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newObject</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        vm<span class="token punctuation">.</span><span class="token function">addLocalObject</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 完整的参数2</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">addLocalObject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayObject</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Number</span> number <span class="token operator">=</span> <span class="token keyword">module</span><span class="token punctuation">.</span><span class="token function">callFunction</span><span class="token punctuation">(</span>emulator<span class="token punctuation">,</span> <span class="token number">0x5a38d</span><span class="token punctuation">,</span> list<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getSign</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">getJNIEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// arg1</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//arg2</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">203</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//arg3</span>
        <span class="token class-name">StringObject</span> input2_1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringObject</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">"9b69f861-e054-4bc4-9daf-d36ae205ed3e"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ByteArray</span> input2_2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArray</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">"GET /api/entry/indexLayer __reqTraceID=aa14663c-9979-445b-a311-8017c596f343&amp;ci=1&amp;group=xxxx&amp;msid=xxxxx&amp;userid=-1&amp;utm_campaign=AgroupBgroupC0E0&amp;utm_content=xxxx&amp;utm_medium=android&amp;utm_source=wandoujia&amp;utm_term=1100090405&amp;uuid=xxxxx&amp;version_name=11.9.405"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DvmInteger</span> input2_3 <span class="token operator">=</span> <span class="token class-name">DvmInteger</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        vm<span class="token punctuation">.</span><span class="token function">addLocalObject</span><span class="token punctuation">(</span>input2_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        vm<span class="token punctuation">.</span><span class="token function">addLocalObject</span><span class="token punctuation">(</span>input2_2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        vm<span class="token punctuation">.</span><span class="token function">addLocalObject</span><span class="token punctuation">(</span>input2_3<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 完整的参数2</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">addLocalObject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayObject</span><span class="token punctuation">(</span>input2_1<span class="token punctuation">,</span> input2_2<span class="token punctuation">,</span> input2_3<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Number</span> number <span class="token operator">=</span> <span class="token keyword">module</span><span class="token punctuation">.</span><span class="token function">callFunction</span><span class="token punctuation">(</span>emulator<span class="token punctuation">,</span> <span class="token number">0x5a38d</span><span class="token punctuation">,</span> list<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        String result = vm.getObject(number.intValue()).getValue().toString();</span>
<span class="token comment">//        return result;</span>

        <span class="token class-name">DvmObject</span><span class="token punctuation">[</span><span class="token punctuation">]</span> result1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">DvmObject</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> vm<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span>number<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> sign <span class="token operator">=</span> result1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sign<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">StringObject</span> result2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">StringObject</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">DvmObject</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ArrayObject</span><span class="token punctuation">)</span>vm<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span>number<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>result2<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result2<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">FileResult</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token class-name">Emulator</span> emulator<span class="token punctuation">,</span> <span class="token class-name">String</span> pathname<span class="token punctuation">,</span> <span class="token keyword">int</span> oflags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"/data/app/com.sankuai.meituan-TEfTAIBttUmUzuVbwRK1DQ==/base.apk"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>pathname<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 填入想要重定位的文件</span>
            <span class="token keyword">return</span> <span class="token class-name">FileResult</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SimpleFileIO</span><span class="token punctuation">(</span>oflags<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"unidbg-android\\src\\test\\java\\com\\xxx\\xxx.apk"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pathname<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre>
  <h2>
   <a aria-hidden="true" class="anchor" href="#知识点总结" id="user-content-知识点总结">
    <span aria-hidden="true" class="octicon octicon-link">
    </span>
   </a>
   知识点总结
  </h2>
  <p>
   1.找不到该native方法引入的哪个so文件时，用hook_RegisterNative脚本分析
  </p>
  <p>
   2.执行结果发现不对返回空指针时，很大可能是逻辑问题，需要结合jnitrace分析
  </p>
  <p>
   3.报dirfd=-100，就是读取文件错误，需要指导程序到正确的路径
  </p>
  <p>
   4.补文件读取有两个方法
  </p>
  <ul>
   <li>
    到unidbg目录，把apk放进去，用这个文件src/main/java/com/github/unidbg/file/BaseFileSystem.java获取当前程序路径
   </li>
   <li>
    还可以用代码的方式进行操作，设置io重定向，把访问的路径放到我们指定的路径即可
   </li>
  </ul>
  <p>
   5.补环境的时候getIntArg是获取方法的参数
  </p>
  <p>
   我的代码是：
  </p>
  <pre class="language-java"><span class="token keyword">int</span> input <span class="token operator">=</span> vaList<span class="token punctuation">.</span><span class="token function">getIntArg</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">return</span> vm<span class="token punctuation">.</span><span class="token function">resolveClass</span><span class="token punctuation">(</span><span class="token string">"java/lang/Integer"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newObject</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
  <p>
   龙哥的代码：
  </p>
  <pre class="language-java"><span class="token keyword">int</span> input <span class="token operator">=</span> vaList<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DvmInteger</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> input<span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
  <p>
   6.如果最后的数据是一个数组而不是字符串，有两种方式获取
  </p>
  <pre class="language-java"><span class="token class-name">StringObject</span> result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">StringObject</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">DvmObject</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ArrayObject</span><span class="token punctuation">)</span>vm<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span>number<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
  <pre class="language-java"><span class="token class-name">DvmObject</span><span class="token punctuation">[</span><span class="token punctuation">]</span> result1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">DvmObject</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> vm<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span>number<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> sign <span class="token operator">=</span> result1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sign<span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
  <script src="prism.js">
  </script>
  <script>
   window.onscroll = function() {
    document.getElementById('catalogue').style.top = window.pageYOffset + 'px';
}
  </script>
 </body>
</html>