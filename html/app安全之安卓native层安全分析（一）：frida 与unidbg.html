<html>
 <head>
  <title>
   app安全之安卓native层安全分析（一）：frida 与unidbg
  </title>
  <link data-noprefix="" href="prism.css" rel="stylesheet">
  <style>
   a{
    color: black;
    text-decoration: none;
}
a:hover{
    color: blue;
}
ul{
    list-style: none;
}
#catalogue {
    top: 10px;
    right: 10px;
    padding: 5px 10px;
    position: absolute;
    border: 1px solid blue;
    background-color: white;
}
  </style>
 </head>
 <body>
  <h1>
   <a>
    app安全之安卓native层安全分析（一）：frida 与unidbg
   </a>
  </h1>
  <ul id="catalogue">
   <li title="返回目录">
    <a href="/html">
     返回目录
    </a>
   </li>
   <li title="前言">
    <a href="#user-content-前言">
     前言
    </a>
   </li>
   <li title="分析">
    <a href="#user-content-分析">
     分析
    </a>
   </li>
   <li title="快速定位">
    <a href="#user-content-快速定位">
     快速定位
    </a>
   </li>
   <li title="unidbg简介">
    <a href="#user-content-unidbg简介">
     unidbg简介
    </a>
   </li>
   <ul>
    <li title="什么是unidbg">
     <a href="#user-content-什么是unidbg">
      什么是unidbg
     </a>
    </li>
    <li title="使用场景">
     <a href="#user-content-使用场景">
      使用场景
     </a>
    </li>
    <li title="配置unidbg">
     <a href="#user-content-配置unidbg">
      配置unidbg
     </a>
    </li>
   </ul>
   <li title="frida调试">
    <a href="#user-content-frida调试">
     frida调试
    </a>
   </li>
   <ul>
    <li title="什么是动态注册、静态注册">
     <a href="#user-content-什么是动态注册、静态注册">
      什么是动态注册、静态注册
     </a>
    </li>
   </ul>
   <li title="unidbg调试">
    <a href="#user-content-unidbg调试">
     unidbg调试
    </a>
   </li>
   <ul>
    <li title="调用">
     <a href="#user-content-调用">
      调用
     </a>
    </li>
   </ul>
   <li title="结语">
    <a href="#user-content-结语">
     结语
    </a>
   </li>
  </ul>
  <h2>
   <a aria-hidden="true" class="anchor" href="#前言" id="user-content-前言">
    <span aria-hidden="true" class="octicon octicon-link">
    </span>
   </a>
   前言
  </h2>
  <p>
   这个专题是根据白龙，龙哥的unidbg博客的案例，进行从0开始到安全分析的流程，核心部分会借鉴龙哥的unidbg，通过借鉴大佬的思路，完整的分析某个so层的加密参数
  </p>
  <p>
   各位朋友也可以直接读龙哥的博客，我只是用我的角度进一步加工一下
  </p>
  <p>
   原文地址：
   <a href="https://blog.csdn.net/qq_38851536/article/details/117418582" rel="nofollow" title="SO入门实战教程一：OASIS_so学习路线_白龙~的博客-CSDN博客">
    SO入门实战教程一：OASIS_so学习路线_白龙~的博客-CSDN博客
   </a>
  </p>
  <h2>
   <a aria-hidden="true" class="anchor" href="#分析" id="user-content-分析">
    <span aria-hidden="true" class="octicon octicon-link">
    </span>
   </a>
   分析
  </h2>
  <p>
   首先拿到这个app，安装啥的就不多说了。
  </p>
  <p>
   进入到注册界面：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/35ca1b0c7190e7585b95c0d3d3a764ce.png" style="max-width: 100%;">
  </p>
  <p>
   点击获取验证码，然后这边抓包工具抓到的包：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/bfe9aebaf0b238cc4b8394b52ef6d049.png" style="max-width: 100%;">
  </p>
  <p>
   然后，这里面的【sign】就是今天的重点了。
  </p>
  <p>
   用神秘的工具脱壳完之后，有如下的dex：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/c575f30203e16746bdaf84291c17a47c.png" style="max-width: 100%;">
  </p>
  <p>
   把这些dex，全部选中，拖进jadx
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/f9b8868eceef8b30dcaa6853a2a4db57.png" style="max-width: 100%;">
  </p>
  <h2>
   <a aria-hidden="true" class="anchor" href="#快速定位" id="user-content-快速定位">
    <span aria-hidden="true" class="octicon octicon-link">
    </span>
   </a>
   快速定位
  </h2>
  <p>
   接下来开始找sign所在的位置，先看看抓包工具这边的参数，根据这些键名，一顿搜，总能找到一些
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/e519284167bdd94876041aa77c55003e.png" style="max-width: 100%;">
  </p>
  <p>
   先搜下【sign】，虽然搜出来的结果不多，但是感觉有很多干扰项
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/c656b8690d732b9dde64a7e3939629d2.png" style="max-width: 100%;">
  </p>
  <p>
   进最后那个，到这里，
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/32321ca47dd1a97290c2257b75de05c3.png" style="max-width: 100%;">
  </p>
  <p>
   这些参数看着很像，用frida hook，得知，发现并没有走到这里
  </p>
  <p>
   搜【ua】
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/565bdbd8b84700e5b550a1123bf997d2.png" style="max-width: 100%;">
  </p>
  <p>
   进到这里，发现很可疑，好多参数都对上了
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/e17bde2370dbae51d4e4d54e114ef415.png" style="max-width: 100%;">
  </p>
  <p>
   啥都不说，先用objection hook下，然后app端点击【重新发送】看看：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/964ceea08cf7c0b93c270395e7c5fcca.png" style="max-width: 100%;">
  </p>
  <p>
   可以，这不直接就定位逻辑了
  </p>
  <p>
   但是我们要找【sign】，所以还得再看看，jadx查看发现，这个方法反编译效果不太好，问题不大，记住这个dex名，然后用GDA 打开这个dex，这就挺好，基本都反编译出来了
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/6cfd48a2dc2819dcdbf4163dd0426ebf.png" style="max-width: 100%;">
  </p>
  <p>
   反正看着确实可疑，但是这三个方法，还不确定到底是是哪个方法里有【sign】部分，所以这里直接hook 它这个a,b，c三个方法，然后app点下重新获取
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/b9ea879b8d944b90fd7eaaac2cf820f3.png" style="max-width: 100%;">
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/5c8b22363f90773e3705aad18c3079e7.png" style="max-width: 100%;">
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/8e415e6b78108cce7b22d727f2705723.png" style="max-width: 100%;">
  </p>
  <p>
   ok，发现最后的方法里基于有我们要的sign，这边再来下，用抓包工具对比下，谨慎一点，别搞半天没搞对位置：
  </p>
  <p>
   重新hook下，然后抓包工具打开看看
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/38da999f92498675d66807433d353464.png" style="max-width: 100%;">
  </p>
  <p>
   对上了，ok，就是这里了【g.a.c.g.c.a】
  </p>
  <p>
   在jadx里，反编译失败：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/ff068af4f405ec3f6a3578b5992e80c8.png" style="max-width: 100%;">
  </p>
  <p>
   问题不大，用GDA看：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/9f36d57884e940bc222d5f72f1920238.png" style="max-width: 100%;">
  </p>
  <p>
   这不就越来越接近了吗，嘻嘻，点进去：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/c90e2b50081ce956f75f5aadbd03f2fa.png" style="max-width: 100%;">
  </p>
  <p>
   hook下这个c方法看看，ok，对上了
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/c43ee6e9d222ffe7a0978b4777469e34.png" style="max-width: 100%;">
  </p>
  <p>
   接着一顿分析后再进入这里
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/8cc73e6ef7a8f5b0774e9a60ec8e0642.png" style="max-width: 100%;">
  </p>
  <p>
   ok，进到了native层，那么核心的逻辑就在这里了。
  </p>
  <p>
   像这种，常规的方法怎么解决呢？
  </p>
  <ul>
   <li>
    如果你是为了拿数据，赶工期的话，那你可以直接主动调用这个方法
   </li>
   <li>
    如果你是为了纯算还原的话，那就把这个so文件拖进ida一顿分析了
   </li>
   <li>
    那么假如，这个方法的纯算很复杂，而你又不想主动调用，感觉很low的话，那你就可以尝试用unidbg了
   </li>
  </ul>
  <p>
   unidbg，就是本系列文章的重点了。
  </p>
  <h2>
   <a aria-hidden="true" class="anchor" href="#unidbg简介" id="user-content-unidbg简介">
    <span aria-hidden="true" class="octicon octicon-link">
    </span>
   </a>
   unidbg简介
  </h2>
  <h3>
   <a aria-hidden="true" class="anchor" href="#什么是unidbg" id="user-content-什么是unidbg">
    <span aria-hidden="true" class="octicon octicon-link">
    </span>
   </a>
   什么是unidbg
  </h3>
  <p>
   unidbg 是一个基于 unicorn 的安全分析工具，可以实现黑盒调用安卓和 iOS 中的 so 文件
  </p>
  <p>
   unidbg是凯神写的一个开源的java项目
  </p>
  <h3>
   <a aria-hidden="true" class="anchor" href="#使用场景" id="user-content-使用场景">
    <span aria-hidden="true" class="octicon octicon-link">
    </span>
   </a>
   使用场景
  </h3>
  <p>
   因为现在的大多数 app 把核心的加密算法放到了 so 文件中（比如本例的app），你要想破解签名算法，必须能够破解 so 文件。但C++ 的安全分析远比 Java 的安全分析要难得多，有各种混淆啊，ollvm啥的，所以好多时候是没法纯算还原破解的
  </p>
  <p>
   那么你是否有过一个想法，能不能把安卓的环境模拟出来，但是又脱离了安卓真机的环境，就可以直接使用so里的方法呢？
  </p>
  <p>
   unidbg 就是这样一个工具，它模拟好了好几种虚拟环境，他不需要直接运行 app，也无需安全分析so 文件，而是直接找到对应的 JNI 接口，然后用 unicorn 引擎（也不止这一个引擎）直接执行这个 so 文件，所以效率也比较高。
  </p>
  <h3>
   <a aria-hidden="true" class="anchor" href="#配置unidbg" id="user-content-配置unidbg">
    <span aria-hidden="true" class="octicon octicon-link">
    </span>
   </a>
   配置unidbg
  </h3>
  <p>
   1.首先，用git 把这个项目clone 下来：
  </p>
  <blockquote>
   <p>
    <a href="https://github.com/zhkl0228/unidbg" title="zhkl0228/unidbg: Allows you to emulate an Android native library, and an experimental iOS emulation (github.com)">
     zhkl0228/unidbg: Allows you to emulate an Android native library, and an experimental iOS emulation (github.com)
    </a>
   </p>
  </blockquote>
  <p>
   2.再用idea（写java项目那个编辑器）打开，
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/dddb8173678dae7973bd8da48e0a2737.png" style="max-width: 100%;">
  </p>
  <p>
   首次打开，右下角会下载很多依赖环境，等待即可
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/97ec4db71bff5d36ffeb8db651419e92.png" style="max-width: 100%;">
  </p>
  <p>
   然后随便找一个项目，执行下main方法，有正常输出，说明环境配置好了：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/fb9506b88f06d441c4cd42be4d2b9052.png" style="max-width: 100%;">
  </p>
  <p>
   执行结果：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/c3dbead1d17fd5cc8e174434edf3967e.png" style="max-width: 100%;">
  </p>
  <p>
   ok，这就很nice。
  </p>
  <h2>
   <a aria-hidden="true" class="anchor" href="#frida调试" id="user-content-frida调试">
    <span aria-hidden="true" class="octicon octicon-link">
    </span>
   </a>
   frida调试
  </h2>
  <p>
   接下来，先用ida 打开那个目标so文件
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/908174159b993b828899ec019786b8f3.png" style="max-width: 100%;">
  </p>
  <p>
   等左下角这个数据没有再变的时候，说明加载好了
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/aa68d2ff48522b7e307fac8baf80585f.png" style="max-width: 100%;">
  </p>
  <p>
   接下来找导出表【export】，或者在左边的栏里搜【java】
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/cea0a363100157087c965954206d998c.png" style="max-width: 100%;">
  </p>
  <p>
   发现并没有任何东西，那么这里就是动态注册的so方法了。
  </p>
  <h3>
   <a aria-hidden="true" class="anchor" href="#什么是动态注册静态注册" id="user-content-什么是动态注册静态注册">
    <span aria-hidden="true" class="octicon octicon-link">
    </span>
   </a>
   什么是动态注册、静态注册
  </h3>
  <p>
   静态注册（又叫静态绑定），就是，so的方法名直接export导出表里，且命名格式为【java_app包名_方法名】，比如 java_com_sina_oasxxx_nativeapi_s
  </p>
  <p>
   动态注册（又叫动态绑定）就是export到处表里没有的就是动态注册。
  </p>
  <p>
   那么这里我们的目标方法就是动态注册的了，那咋办，看看JNI_load方法：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/d9d61469a83db10db836181746a60585.png" style="max-width: 100%;">
  </p>
  <p>
   按下【tab】键，会由上面的汇编代码反编译为c代码：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/a75a62521a1c0df9c8e0916146fb566a.png" style="max-width: 100%;">
  </p>
  <p>
   再按下【\】反斜杠，可读性更强点：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/6c151e947deee77f9cf4ae1883e43eac.png" style="max-width: 100%;">
  </p>
  <p>
   但是这里发现，一顿while 和if，根据龙哥的博客说的，大概率是ollvm混淆。那咋办？
  </p>
  <p>
   用yang神的hook_native脚本来hook出目标函数的偏移地址 ，然后加上so的基址，就可以得到目标函数的地址了（看是thumb还是arm，thumb要加1，arm不用）
  </p>
  <blockquote>
   <p>
    <a href="https://github.com/lasting-yang/frida_hook_libart/blob/master/hook_RegisterNatives.js" title="frida_hook_libart/hook_RegisterNatives.js at master &middot; lasting-yang/frida_hook_libart (github.com)">
     frida_hook_libart/hook_RegisterNatives.js at master &middot; lasting-yang/frida_hook_libart (github.com)
    </a>
   </p>
  </blockquote>
  <p>
   用frida hook一下，结果到这就报错退出了
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/9105e0a5f8257d796ac7199b313b0217.png" style="max-width: 100%;">
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/110a1e7b22e45e503e20e2657585bbce.png" style="max-width: 100%;">
  </p>
  <p>
   就很尴尬，看看，他报的哪个class名，用来过滤下试试：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/8639498911b224ee160d545f257abcec.png" style="max-width: 100%;">
  </p>
  <p>
   重新运行frida试试，可以，这下直接就定位到我们要的方法的位置了：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/4fc5344d9aef5fd4c25bb2f6b5ec4edf.png" style="max-width: 100%;">
  </p>
  <p>
   这里有朋友估计会说，卧槽，这不都出来了吗，这地址，拿着直接用啊，不急，我重启脚本看看：仔细看，fnptr地址变了，fnoffset和后面的jni-load + 的地址没变的
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/4e5c138ce9d190c94e9e6021bf933906.png" style="max-width: 100%;">
  </p>
  <p>
   多次hook发现确实如此，因为这里就是上面说的动态注册，所以这个fnptr，也就是so的基址，app没启动一次就会变，但是目标方法的偏移值是不会变的。ok
  </p>
  <p>
   用frida hook so看看：
  </p>
  <p>
   相关的hoo so，有个大佬总结的很好：
  </p>
  <blockquote>
   <p>
    <a href="https://kevinspider.github.io/frida/frida-hook-so/" rel="nofollow" title="分类: frida | 凡墙总是门 (kevinspider.github.io)">
     分类: frida | 凡墙总是门 (kevinspider.github.io)
    </a>
   </p>
  </blockquote>
  <p>
   ok，这里我们hook下，拿下入参和返回值看看：
  </p>
  <pre class="language-js"><span class="token keyword">function</span> <span class="token function">inline_hook</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">var</span> so_addr <span class="token operator">=</span> Module<span class="token punctuation">.</span><span class="token function">findBaseAddress</span><span class="token punctuation">(</span><span class="token string">"liboasiscore.so"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"so_addr:"</span><span class="token punctuation">,</span> so_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token parameter">so_addr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">var</span> sub <span class="token operator">=</span> so_addr<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x116cc</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 不用加1，是arm架构</span>

        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"The addr_0x116cc:"</span><span class="token punctuation">,</span> sub<span class="token punctuation">)</span><span class="token punctuation">;</span>

        Java<span class="token punctuation">.</span><span class="token function">perform</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            Interceptor<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>sub<span class="token punctuation">,</span>

                <span class="token punctuation">{</span>

                    <span class="token function-variable function">onEnter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"addr_0x116cc OnEnter :"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token constant">PC</span><span class="token punctuation">,</span>

                            <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span>x1<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span>x5<span class="token punctuation">,</span>

                            <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span>x10<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token punctuation">}</span><span class="token punctuation">,</span>

                    <span class="token function-variable function">onLeave</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">retval</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"retval is :"</span><span class="token punctuation">,</span> retval<span class="token punctuation">)</span>

                    <span class="token punctuation">}</span><span class="token punctuation">,</span>

                <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>





<span class="token function">setTimeout</span><span class="token punctuation">(</span>inline_hook<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span></pre>
  <p>
   运行结果：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/415875ac6bf7445e5445453c8ac58539.png" style="max-width: 100%;">
  </p>
  <p>
   发现并不可读，没事，反正至少是有了
  </p>
  <pre class="language-js"><span class="token keyword">function</span> <span class="token function">stringToBytes</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">return</span> <span class="token function">hexToBytes</span><span class="token punctuation">(</span><span class="token function">stringToHex</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span>



<span class="token keyword">function</span> <span class="token function">stringToHex</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">return</span> str

    <span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>

    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">c</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token string">'0'</span> <span class="token operator">+</span> c<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span>

    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span>



<span class="token keyword">function</span> <span class="token function">hexToBytes</span><span class="token punctuation">(</span><span class="token parameter">hex</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> bytes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> c <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> c <span class="token operator">&lt;</span> hex<span class="token punctuation">.</span>length<span class="token punctuation">;</span> c <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">)</span> bytes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">parseInt</span><span class="token punctuation">(</span>hex<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> bytes

<span class="token punctuation">}</span>



<span class="token keyword">function</span> <span class="token function">hexToString</span><span class="token punctuation">(</span><span class="token parameter">hexStr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">let</span> hex <span class="token operator">=</span> hexStr<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">let</span> str <span class="token operator">=</span> <span class="token string">''</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> hex<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">)</span> str <span class="token operator">+=</span> String<span class="token punctuation">.</span><span class="token function">fromCharCode</span><span class="token punctuation">(</span><span class="token function">parseInt</span><span class="token punctuation">(</span>hex<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> str

<span class="token punctuation">}</span></pre>
  <pre class="language-js"><span class="token keyword">function</span> <span class="token function">inline_hook</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">var</span> so_addr <span class="token operator">=</span> Module<span class="token punctuation">.</span><span class="token function">findBaseAddress</span><span class="token punctuation">(</span><span class="token string">"liboasiscore.so"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"so_addr:"</span><span class="token punctuation">,</span> so_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token parameter">so_addr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// var sub = so_addr.add(0x116cc); // 不用加1，是arm架构</span>

        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"The addr_0x116cc:"</span><span class="token punctuation">,</span> so_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">var</span> ss <span class="token operator">=</span> <span class="token string">"aid=01A8SBOtNRVqsR1ywgkR4tHsZEsgXkGDrgKO2OvFBeThKWZDE.&amp;cfrom=28B5295010&amp;cuid=0&amp;noncestr=L83x8Z40132Wan450y736563n3kmWj&amp;phone=138469655665&amp;platform=ANDROID&amp;timestamp=1681790293128&amp;ua=Xiaomi-MI6__oasis__3.5.8__Android__Android9&amp;version=3.5.8&amp;vid=2010511512550&amp;wm=20004_90024"</span><span class="token punctuation">;</span>

        <span class="token keyword">var</span> add_addr <span class="token operator">=</span> so_addr<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0x116cc</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 32位需要加1</span>

        <span class="token keyword">var</span> add <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NativeFunction</span><span class="token punctuation">(</span>add_addr<span class="token punctuation">,</span> <span class="token string">'pointer'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'pointer'</span><span class="token punctuation">,</span> <span class="token string">'int'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>add<span class="token punctuation">)</span>

        <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token function">stringToByte</span><span class="token punctuation">(</span>Memory<span class="token punctuation">.</span><span class="token function">allocUtf8String</span><span class="token punctuation">(</span>ss<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>

        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"add2 result is -&gt;"</span> <span class="token operator">+</span> result<span class="token punctuation">.</span><span class="token function">readCString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>



<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">stringToByte</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">var</span> ch<span class="token punctuation">,</span> st<span class="token punctuation">,</span> re <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> str<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        ch <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>

        st <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token keyword">do</span> <span class="token punctuation">{</span>

            st<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>ch <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            ch <span class="token operator">=</span> ch <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">;</span>

        re <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>st<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>   <span class="token comment">// return an array of bytes</span>

    <span class="token keyword">return</span> re<span class="token punctuation">;</span>

<span class="token punctuation">}</span>



<span class="token function">setTimeout</span><span class="token punctuation">(</span>inline_hook<span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span></pre>
  <p>
   尝试主动调用，调试了很久，就是不行
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/5b649fa5853ae97d39fe260f958a7d4d.png" style="max-width: 100%;">
  </p>
  <p>
   突然反应过来，这个so文件有ollvm混淆啊，虽然用yang神的代码hook到了偏移地址，但是他内部可能并不是这些参数，而我们又没法直接分析，那没法了。其实以上的代码，在其他地方是可以用的，
  </p>
  <p>
   那接下来咋办？上unidbg吧
  </p>
  <h2>
   <a aria-hidden="true" class="anchor" href="#unidbg调试" id="user-content-unidbg调试">
    <span aria-hidden="true" class="octicon octicon-link">
    </span>
   </a>
   unidbg调试
  </h2>
  <p>
   上面用了frida+ida调试，发现有的时候没法搞啊，那么这里，终于要用unidbg来模拟执行生成上面目标app的sign了
  </p>
  <p>
   先创建一个文件，把该有的都放进去
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/83dd6933b5a4e81b4f42f340ab80da6d.png" style="max-width: 100%;">
  </p>
  <p>
   然后再oasis里写代码，照着龙哥的搞就完了：注意文件路径，跟你实际的路径保持一致
  </p>
  <pre class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>sina</span><span class="token punctuation">;</span>



<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span></span><span class="token class-name">AndroidEmulator</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span></span><span class="token class-name">Module</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span>linux<span class="token punctuation">.</span>android<span class="token punctuation">.</span></span><span class="token class-name">AndroidEmulatorBuilder</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span>linux<span class="token punctuation">.</span>android<span class="token punctuation">.</span></span><span class="token class-name">AndroidResolver</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span>linux<span class="token punctuation">.</span>android<span class="token punctuation">.</span>dvm<span class="token punctuation">.</span></span><span class="token class-name">AbstractJni</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span>linux<span class="token punctuation">.</span>android<span class="token punctuation">.</span>dvm<span class="token punctuation">.</span></span><span class="token class-name">DalvikModule</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span>linux<span class="token punctuation">.</span>android<span class="token punctuation">.</span>dvm<span class="token punctuation">.</span></span><span class="token class-name">VM</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span>memory<span class="token punctuation">.</span></span><span class="token class-name">Memory</span></span><span class="token punctuation">;</span>



<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">File</span></span><span class="token punctuation">;</span>



<span class="token keyword">public</span> <span class="token keyword">class</span> oasis <span class="token keyword">extends</span> <span class="token class-name">AbstractJni</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AndroidEmulator</span> emulator<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">VM</span> vm<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Module</span> <span class="token keyword">module</span><span class="token punctuation">;</span>



    <span class="token function">oasis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// 创建模拟器实例,进程名建议依照实际进程名填写，可以规避针对进程名的校验</span>

        emulator <span class="token operator">=</span> <span class="token class-name">AndroidEmulatorBuilder</span><span class="token punctuation">.</span><span class="token function">for32Bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setProcessName</span><span class="token punctuation">(</span><span class="token string">"com.sina.oasis"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 获取模拟器的内存操作接口</span>

        <span class="token keyword">final</span> <span class="token class-name">Memory</span> memory <span class="token operator">=</span> emulator<span class="token punctuation">.</span><span class="token function">getMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 设置系统类库解析</span>

        memory<span class="token punctuation">.</span><span class="token function">setLibraryResolver</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AndroidResolver</span><span class="token punctuation">(</span><span class="token number">23</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 创建Android虚拟机,传入APK，Unidbg可以替我们做部分签名校验的工作</span>

        vm <span class="token operator">=</span> emulator<span class="token punctuation">.</span><span class="token function">createDalvikVM</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"unidbg-android\\src\\test\\java\\com\\sina\\lvzhou.apk"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 加载目标SO</span>

        <span class="token class-name">DalvikModule</span> dm <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"unidbg-android\\src\\test\\java\\com\\sina\\liboasiscore.so"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 加载so到虚拟内存</span>

        <span class="token comment">//获取本SO模块的句柄,后续需要用它</span>

        <span class="token keyword">module</span> <span class="token operator">=</span> dm<span class="token punctuation">.</span><span class="token function">getModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        vm<span class="token punctuation">.</span><span class="token function">setJni</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置JNI</span>

        vm<span class="token punctuation">.</span><span class="token function">setVerbose</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 打印日志</span>



        dm<span class="token punctuation">.</span><span class="token function">callJNI_OnLoad</span><span class="token punctuation">(</span>emulator<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用JNI OnLoad</span>

    <span class="token punctuation">}</span><span class="token punctuation">;</span>



    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        oasis test <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">oasis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span></pre>
  <p>
   然后运行一下，没啥问题，说明架子是搭上了
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/ddf6640d36f90dcad3204f70870f88d3.png" style="max-width: 100%;">
  </p>
  <p>
   仔细看这里，这样也把我们要的方法的地址拿到了。舒服啊
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/4f7ed9d1f4b91a6de7380471db61117d.png" style="max-width: 100%;">
  </p>
  <p>
   用前面frida 的对比，好像不太一样，问题不大
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/6cf582c339bda196e58007240f7a9f78.png" style="max-width: 100%;">
  </p>
  <p>
   再来看看代码：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/d6de83b417336db5442487c575ab0068.png" style="max-width: 100%;">
  </p>
  <p>
   再来仔细看看他这个main干了啥：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/095a1ab9dd1f72aeb95d3fa2203febf6.png" style="max-width: 100%;">
  </p>
  <h3>
   <a aria-hidden="true" class="anchor" href="#调用" id="user-content-调用">
    <span aria-hidden="true" class="octicon octicon-link">
    </span>
   </a>
   调用
  </h3>
  <p>
   架子搭好了，接下来调用，调用有两种方式，一种是符号（symbol）调用，一种是地址调用，符号调用对应静态注册，地址调用对应动态注册。那么根据前面的解析，这里我们只能选用地址调用了
  </p>
  <p>
   先看看我们要调用的方法：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/c27bc186f21936a349dc1ec425879d76.png" style="max-width: 100%;">
  </p>
  <p>
   有两个参数，一个byte数组，一个boolean，然后native层的方法，默认前面会自动加两个参数 ，一个jni env，一个jobject
  </p>
  <p>
   还是上面的frida脚本，先hook下，看看入参和返回：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/a75324e856469d745aaf2c524ffb4ab8.png" style="max-width: 100%;">
  </p>
  <p>
   ok，直接拿着这个str参数的值去unidbg构造：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/205d56d25a8106668bd8ccb5c0cd6d49.png" style="max-width: 100%;">
  </p>
  <p>
   注意，如果你用的旧版，也就是龙哥案例的代码，直接报错：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/788f2eb4bf7af6b4ad1859e61bc1d1f3.png" style="max-width: 100%;">
  </p>
  <p>
   新版得这么用，运行结果：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/cbf302928ba7e68971e6411760245a73.png" style="max-width: 100%;">
  </p>
  <pre class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>sina</span><span class="token punctuation">;</span>



<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span></span><span class="token class-name">AndroidEmulator</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span></span><span class="token class-name">Module</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span>linux<span class="token punctuation">.</span>android<span class="token punctuation">.</span></span><span class="token class-name">AndroidEmulatorBuilder</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span>linux<span class="token punctuation">.</span>android<span class="token punctuation">.</span></span><span class="token class-name">AndroidResolver</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span>linux<span class="token punctuation">.</span>android<span class="token punctuation">.</span>dvm<span class="token punctuation">.</span></span><span class="token class-name">AbstractJni</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span>linux<span class="token punctuation">.</span>android<span class="token punctuation">.</span>dvm<span class="token punctuation">.</span></span><span class="token class-name">DalvikModule</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span>linux<span class="token punctuation">.</span>android<span class="token punctuation">.</span>dvm<span class="token punctuation">.</span></span><span class="token class-name">VM</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span>linux<span class="token punctuation">.</span>android<span class="token punctuation">.</span>dvm<span class="token punctuation">.</span>array<span class="token punctuation">.</span></span><span class="token class-name">ByteArray</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span>memory<span class="token punctuation">.</span></span><span class="token class-name">Memory</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>jna<span class="token punctuation">.</span></span><span class="token class-name">Pointer</span></span><span class="token punctuation">;</span>



<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">File</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>charset<span class="token punctuation">.</span></span><span class="token class-name">StandardCharsets</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span><span class="token class-name">Number</span></span><span class="token punctuation">;</span>



<span class="token keyword">public</span> <span class="token keyword">class</span> oasis <span class="token keyword">extends</span> <span class="token class-name">AbstractJni</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AndroidEmulator</span> emulator<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">VM</span> vm<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Module</span> <span class="token keyword">module</span><span class="token punctuation">;</span>



    <span class="token function">oasis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// 创建模拟器实例,进程名建议依照实际进程名填写，可以规避针对进程名的校验</span>

        emulator <span class="token operator">=</span> <span class="token class-name">AndroidEmulatorBuilder</span><span class="token punctuation">.</span><span class="token function">for32Bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setProcessName</span><span class="token punctuation">(</span><span class="token string">"com.sina.oasis"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 获取模拟器的内存操作接口</span>

        <span class="token keyword">final</span> <span class="token class-name">Memory</span> memory <span class="token operator">=</span> emulator<span class="token punctuation">.</span><span class="token function">getMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 设置系统类库解析</span>

        memory<span class="token punctuation">.</span><span class="token function">setLibraryResolver</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AndroidResolver</span><span class="token punctuation">(</span><span class="token number">23</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 创建Android虚拟机,传入APK，Unidbg可以替我们做部分签名校验的工作</span>

        vm <span class="token operator">=</span> emulator<span class="token punctuation">.</span><span class="token function">createDalvikVM</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"unidbg-android\\src\\test\\java\\com\\sina\\lvzhou.apk"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 加载目标SO</span>

        <span class="token class-name">DalvikModule</span> dm <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"unidbg-android\\src\\test\\java\\com\\sina\\liboasiscore.so"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 加载so到虚拟内存</span>

        <span class="token comment">//获取本SO模块的句柄,后续需要用它</span>

        <span class="token keyword">module</span> <span class="token operator">=</span> dm<span class="token punctuation">.</span><span class="token function">getModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        vm<span class="token punctuation">.</span><span class="token function">setJni</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置JNI</span>

        vm<span class="token punctuation">.</span><span class="token function">setVerbose</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 打印日志</span>



        dm<span class="token punctuation">.</span><span class="token function">callJNI_OnLoad</span><span class="token punctuation">(</span>emulator<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用JNI OnLoad</span>

    <span class="token punctuation">}</span><span class="token punctuation">;</span>



    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        oasis test <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">oasis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>test<span class="token punctuation">.</span><span class="token function">getSign</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getSign</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">getJNIEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// arg1,env</span>

        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// arg2,jobject</span>

        <span class="token class-name">String</span> keywords <span class="token operator">=</span> <span class="token string">"aid=01A8SBOtNRVqsR1ywgkR4tHsZEsgXkGDrgKO2OvFBeThKWZDE.&amp;cfrom=28B5295010&amp;cuid=0&amp;noncestr=L83x8Z40132Wan450y736563n3kmWj&amp;phone=xxxxx&amp;platform=ANDROID&amp;timestamp=1681790293128&amp;ua=Xiaomi-MI6__oasis__3.5.8__Android__Android9&amp;version=3.5.8&amp;vid=2010511512550&amp;wm=20004_90024"</span><span class="token punctuation">;</span>

        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> keyB <span class="token operator">=</span> keywords<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ByteArray</span> inbarr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArray</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span>keyB<span class="token punctuation">)</span><span class="token punctuation">;</span>

        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">addGlobalObject</span><span class="token punctuation">(</span>inbarr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//arg3</span>

        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//arg4</span>

<span class="token comment">//        Number number = module.callFunction(emulator,0xC365,list.toArray())[0];</span>

        <span class="token class-name">Number</span> number <span class="token operator">=</span> <span class="token keyword">module</span><span class="token punctuation">.</span><span class="token function">callFunction</span><span class="token punctuation">(</span>emulator<span class="token punctuation">,</span><span class="token number">0xC365</span><span class="token punctuation">,</span>list<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> result <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span>number<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> result<span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span></pre>
  <p>
   验证下结果，对上了，舒服：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/09601d634c68f1251c2800c4287b5a4a.png" style="max-width: 100%;">
  </p>
  <h2>
   <a aria-hidden="true" class="anchor" href="#结语" id="user-content-结语">
    <span aria-hidden="true" class="octicon octicon-link">
    </span>
   </a>
   结语
  </h2>
  <p>
   unidbg的实用之处就在这里，相信不用我多说，你已经发现了很多妙用之处
  </p>
  <script src="prism.js">
  </script>
  <script>
   window.onscroll = function() {
    document.getElementById('catalogue').style.top = window.pageYOffset + 'px';
}
  </script>
 </body>
</html>