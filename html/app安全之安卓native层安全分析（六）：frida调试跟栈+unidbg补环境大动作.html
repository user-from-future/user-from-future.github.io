<html>
 <head>
  <title>
   app安全之安卓native层安全分析（六）：frida调试跟栈+unidbg补环境大动作
  </title>
  <link data-noprefix="" href="prism.css" rel="stylesheet">
  <style>
   a{
    color: black;
    text-decoration: none;
}
a:hover{
    color: blue;
}
ul{
    list-style: none;
}
#catalogue {
    top: 10px;
    right: 10px;
    padding: 5px 10px;
    position: absolute;
    border: 1px solid blue;
    background-color: white;
}
  </style>
 </head>
 <body>
  <h1>
   <a>
    app安全之安卓native层安全分析（六）：frida调试跟栈+unidbg补环境大动作
   </a>
  </h1>
  <ul id="catalogue">
   <li title="返回目录">
    <a href="/html">
     返回目录
    </a>
   </li>
   <li title="前言">
    <a href="#user-content-前言">
     前言
    </a>
   </li>
   <li title="分析">
    <a href="#user-content-分析">
     分析
    </a>
   </li>
   <li title="调试">
    <a href="#user-content-调试">
     调试
    </a>
   </li>
   <ul>
    <li title="1.找so文件">
     <a href="#user-content-1找so文件">
      1.找so文件
     </a>
    </li>
    <li title="2.搭架子">
     <a href="#user-content-2搭架子">
      2.搭架子
     </a>
    </li>
    <li title="3.开始调用s方法">
     <a href="#user-content-3开始调用s方法">
      3.开始调用s方法
     </a>
    </li>
    <li title="4.直接补类">
     <a href="#user-content-4直接补类">
      4.直接补类
     </a>
    </li>
   </ul>
   <li title="知识点总结">
    <a href="#user-content-知识点总结">
     知识点总结
    </a>
   </li>
  </ul>
  <h2>
   <a aria-hidden="true" class="anchor" href="#前言" id="user-content-前言">
    <span aria-hidden="true" class="octicon octicon-link">
    </span>
   </a>
   前言
  </h2>
  <p>
   继续跟着龙哥的unidbg学习：
   <a href="https://blog.csdn.net/qq_38851536/article/details/117923970" rel="nofollow" title="SO逆向入门实战教程六：s_白龙~的博客-CSDN博客">
    SO逆向入门实战教程六：s_白龙~的博客-CSDN博客
   </a>
  </p>
  <p>
   还是那句，我会借鉴龙哥的文章，以一个初学者的角度，加上自己的理解，把内容丰富一下，尽量做到不在龙哥的基础上画蛇添足，哈哈。感谢观看的朋友
  </p>
  <h2>
   <a aria-hidden="true" class="anchor" href="#分析" id="user-content-分析">
    <span aria-hidden="true" class="octicon octicon-link">
    </span>
   </a>
   分析
  </h2>
  <p>
   首先抓个包看看：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/49e44a445cdad42e4c7dfcb4b07a4c13.png" style="max-width: 100%;">
  </p>
  <p>
   这里面这个sign，就是今天的重点了
  </p>
  <p>
   这个app没有壳，直接jadx打开，然后搜【sign"】或者【sign=】
  </p>
  <p>
   很快的，就找到这个地方
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/c75cf80c777da44bf18e6ec438456b97.png" style="max-width: 100%;">
  </p>
  <p>
   目前确实还不确定是不是这里，用objection hook下就知道了：
  </p>
  <p>
   先hook了类，一堆，卧槽
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/f81ada7a4654522431e65c97ea982949.png" style="max-width: 100%;">
  </p>
  <p>
   hook tostring方法：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/d71b54a9165ae94eac9ccae54a5fe282.png" style="max-width: 100%;">
  </p>
  <p>
   app多划两下：可以看到基本是对的上的
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/73495a176d3f4378f1c807759ae3d4bd.png" style="max-width: 100%;">
  </p>
  <p>
   然后再找找堆栈调用，很快定位到这里：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/42df460fc999ca7a05f3a805286ea594.png" style="max-width: 100%;">
  </p>
  <p>
   hook下这个类，发现有一堆，
  </p>
  <p>
   慢慢来，首先这个appkey，就是这里了
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/8c1e7c7b81eaca442fbd33b48ce3cdcf.png" style="max-width: 100%;">
  </p>
  <p>
   根据龙哥说的，就是libBili.s方法，但是hook了之后就加载就一直卡住。换用fridahook :
  </p>
  <pre class="language-js"><span class="token keyword">function</span> <span class="token function">showStacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>

                Java<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">"android.util.Log"</span><span class="token punctuation">)</span>

                    <span class="token punctuation">.</span><span class="token function">getStackTraceString</span><span class="token punctuation">(</span>

                        Java<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">"java.lang.Throwable"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>$<span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

                    <span class="token punctuation">)</span>

            <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    Java<span class="token punctuation">.</span><span class="token function">perform</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">var</span> ClassName <span class="token operator">=</span> <span class="token string">"com.bilibili.nativelibrary.LibBili"</span><span class="token punctuation">;</span>

        <span class="token keyword">var</span> Bilibili <span class="token operator">=</span> Java<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>ClassName<span class="token punctuation">)</span><span class="token punctuation">;</span>

        Bilibili<span class="token punctuation">.</span>s<span class="token punctuation">.</span><span class="token function">overload</span><span class="token punctuation">(</span><span class="token string">'java.util.SortedMap'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">implementation</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">arg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span>

            Java<span class="token punctuation">.</span><span class="token function">openClassFile</span><span class="token punctuation">(</span><span class="token string">"/data/local/tmp/r0gson.dex"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token keyword">const</span> gson <span class="token operator">=</span> Java<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'com.r0ysue.gson.Gson'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>$<span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">const</span> json_x <span class="token operator">=</span> gson<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span>

            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"json_x===&gt;"</span><span class="token punctuation">,</span> json_x<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">s</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span>

            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'result===&gt;'</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span>



            <span class="token function">showStacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token keyword">return</span> res<span class="token punctuation">;</span>

        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>



<span class="token function">setTimeout</span><span class="token punctuation">(</span>main<span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span></pre>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/91770aca68de37879d994cf21f4a1b37.png" style="max-width: 100%;">
  </p>
  <p>
   感觉就是这个s了，入参是：
  </p>
  <blockquote>
   <p>
    {"ad_extra":"E0DA3BAB712CAB3902D558CFD4FEB865AB1563B7D61A4A57D02854BB9A4512C5E4737CA15664C505F3E63B954BB68837690B81FE77B2E7EB578F3E3D7C528439725348FE86527D7415BA2267FCCD2C95895AE80E69A960812FE60
    <br>
    BC477171DAD34472EC31D010940A2876CADE887EA26FD5FBFB718D09F193D14732E54E42EB329EBF61CA33DE876AF24C03A7B9E89DB9C831AF6D1CB8B3B883AA3856AF08424AD8913BDE1207A5C2E010E23274ECCA7BC44814561E236325F0C4D2FFE069D2F9B
    <br>
    F5B40411A3D26D0BB864EC87713391FAE1197ACFD402D6D386B035BF04995C280989B7305964F179E149067FA864F66FA856EFBD3C8A005F92F1D7C93D82BC8C5B4804DC54154F34E5820B2A481C3F33EEDDB4323C142359920F60686D95E715E30894676AEDE
    <br>
    6933A31092E98F979157D267D580D056C3EDDD31934E762D7354A2E1959AAD44D1DDAF094B6E8F38C5450C6A164BD40AF2C3FB2E44BD8E0F914C7BA0FBA4FA553A2A1291BAF9E87FC528C2D53A6B3D3EFEA88F5C359119A31018AD879124BE62B4A4BCFEF98FA
    <br>
    5EE1BB5675D9828D1B246A10841CF1F6D1CC1C13C3C11C7E37BCEF93E933395A1FA4D7AEA4CB79DC3ED1EC162C926CFE1157366100A3AF788CF3262DC381B620FB68913694FD332D7D555CD60E3AC54E2F0A5FC2C90530A27721664A64B008FAB0A6","appkey
    <br>
    ":"1d8b6e7d45233436","autoplay_card":"11","build":"6180500","c_locale":"zh_CN","channel":"shenma069","column":"2","device_name":"MI 6","device_type":"0","flush":"8","fnval":"400","fnver":"0","force_host":"
    <br>
    0","fourk":"1","guidance":"0","https_url_req":"0","idx":"1682561936","inline_danmu":"2","inline_sound":"1","login_event":"0","mobi_app":"android","network":"wifi","open_event":"","platform":"android","play
    <br>
    er_net":"1","pull":"false","qn":"32","recsys_mode":"0","s_locale":"zh_CN","splash_id":"","statistics":"{\"appId\":1,\"platform\":3,\"version\":\"6.18.0\",\"abtest\":\"\"}"}
   </p>
  </blockquote>
  <p>
   我上面的流程只是为了完整的展示，拿到app，定位加密，然后开始分析的，看过我前面的文章的应该都知道我在干嘛。
  </p>
  <h2>
   <a aria-hidden="true" class="anchor" href="#调试" id="user-content-调试">
    <span aria-hidden="true" class="octicon octicon-link">
    </span>
   </a>
   调试
  </h2>
  <p>
   ok，那就开始so层的调试和分析了
  </p>
  <h3>
   <a aria-hidden="true" class="anchor" href="#1找so文件" id="user-content-1找so文件">
    <span aria-hidden="true" class="octicon octicon-link">
    </span>
   </a>
   1.找so文件
  </h3>
  <p>
   apk我们知道，但是so文件，在这里，乍一看啥都没有：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/8ab7682af842b92eb56d289d00b081c2.png" style="max-width: 100%;">
  </p>
  <p>
   根据我们之前的定律，加载so文件都是static方法，然后，system.loadlibrary，但是这里就奇怪了，啥都没有
  </p>
  <p>
   只看到这里有点可疑：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/09078f2e8f239777b6dc98fbdceb5944.png" style="max-width: 100%;">
  </p>
  <p>
   点进去，知道G是bili
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/3a2cb694630f5321c7f30b35325ba2dd.png" style="max-width: 100%;">
  </p>
  <p>
   c.c会不会是system.loadlibrary呢？追进去：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/f5e6cf15af42a2703f89895cf1c56072.png" style="max-width: 100%;">
  </p>
  <p>
   看到使用str只有f，其他的逻辑我们可以不用管
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/b4ff14b8359f2a0eecd3bfe76495f271.png" style="max-width: 100%;">
  </p>
  <p>
   f追进去，我们知道，后面两个参数是null，因为根本就没传这两个，那就是这个g方法
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/45dc5c84fe906098b6a6e895590bcf80.png" style="max-width: 100%;">
  </p>
  <p>
   g追进去，然后一下就看到了这个loadlibrary:
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/509aa9e83232e99f5960959be6c9dc17.png" style="max-width: 100%;">
  </p>
  <p>
   再追进去，感觉这个【com.getkeepsafe.relinker】类有点奇怪
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/bd6d1ae643fdb12e609c766d49ecdc19.png" style="max-width: 100%;">
  </p>
  <p>
   网上搜一下即可：
  </p>
  <blockquote>
   <p>
    <a href="https://github.com/KeepSafe/ReLinker" title="KeepSafe/ReLinker：一个强大的Android原生库加载器。 (github.com)">
     KeepSafe/ReLinker：一个强大的Android原生库加载器。 (github.com)
    </a>
   </p>
  </blockquote>
  <p>
   看到这个介绍，ok，就是这里了。
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/aa29c2699404fea2a9ac7b2a1cde4a7c.png" style="max-width: 100%;">
  </p>
  <p>
   所以我们的so文件就是这个bili了。
  </p>
  <h3>
   <a aria-hidden="true" class="anchor" href="#2搭架子" id="user-content-2搭架子">
    <span aria-hidden="true" class="octicon octicon-link">
    </span>
   </a>
   2.搭架子
  </h3>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/6706cfb79ebac8d0ff12852b61ecf8f1.png" style="max-width: 100%;">
  </p>
  <p>
   又报了这个错：
  </p>
  <blockquote>
   <p>
    [main]W/libc: pthread_create failed: clone failed: Out of memory
   </p>
  </blockquote>
  <p>
   前面我们已经用过了：
  </p>
  <p>
   在这加一行这个
  </p>
  <blockquote>
   <p>
    emulator.getSyscallHandler().setEnableThreadDispatcher(true);
   </p>
  </blockquote>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/650216143e180a7871b011c09e881dbe.png" style="max-width: 100%;">
  </p>
  <p>
   ok了
  </p>
  <p>
   而且，我们的目标函数地址也打印出来了：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/e4b7542b132e61395884fae04f0623e5.png" style="max-width: 100%;">
  </p>
  <h3>
   <a aria-hidden="true" class="anchor" href="#3开始调用s方法" id="user-content-3开始调用s方法">
    <span aria-hidden="true" class="octicon octicon-link">
    </span>
   </a>
   3.开始调用s方法
  </h3>
  <p>
   但是参数是TreeMap，根据龙哥的博客说的，需要搞个继承关系，map-&gt;abstractMap-&gt;TreeMap
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/d753cbe361466cef0513eb4b86863ede.png" style="max-width: 100%;">
  </p>
  <p>
   补一下：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/5466e870b8387693c48d0c0dc1ed0187.png" style="max-width: 100%;">
  </p>
  <p>
   继续补：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/ff9f1bf0f78f8ac1e414482cd2f9a4d5.png" style="max-width: 100%;">
  </p>
  <p>
   插一句，如果这里，你没给ts，会报如下错，而且提示都没有，就很骚，我是用frida hook到的某一个流程的参数，刚好就没有ts。但是实际调用的时候是有ts的：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/113505edb7f7564133e9c205e703a8ff.png" style="max-width: 100%;">
  </p>
  <p>
   回到刚才的地方，卧槽，他这里要一个&nbsp;SignedQuery对象的r方法，也就是这个：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/720529b39c76261ca89826c799936594.png" style="max-width: 100%;">
  </p>
  <p>
   新建了一个util类，然后把jadx的copy过来，导入好已有的，然后如下：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/2b4c1819dea917a96333243979982a85.png" style="max-width: 100%;">
  </p>
  <p>
   把ContainerUtils的这两个属性拿过来：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/04f42714cee52afe322ddb0bfe9b6e14.png" style="max-width: 100%;">
  </p>
  <p>
   现在就差b方法了
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/f2dc560fd9a059dfc1e47eb6024b4bab.png" style="max-width: 100%;">
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/9f9491af04150be43d95d356d5123414.png" style="max-width: 100%;">
  </p>
  <p>
   把a,b,c都copy完，还有这个：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/43c1d97b3f1567e511be9e93049c90b5.png" style="max-width: 100%;">
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/a68468286d9b6f98181c5420dd7363f5.png" style="max-width: 100%;">
  </p>
  <p>
   整过来
  </p>
  <p>
   现在还有cv.m了，
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/1d6a84fdb470d5b73c9e55bba45ccfc6.png" style="max-width: 100%;">
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/0062b4cf9b10391c3e49bbdf114c03fb.png" style="max-width: 100%;">
  </p>
  <p>
   ok，整好了运行，卧槽，还要这个初始化对象：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/09f88e28608fc7c42d7490636c2e2ac0.png" style="max-width: 100%;">
  </p>
  <p>
   再看看这个类的构造方法是啥：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/313473a1b1b0491a1af648513aa00e75.png" style="max-width: 100%;">
  </p>
  <p>
   也还好，就两个属性
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/9e6b4189548c5773bb6eae3ba68cdf2f.png" style="max-width: 100%;">
  </p>
  <p>
   好了终于没有报错了，发现，这个第二个参数就是sign：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/766ead798e65c571f459a554d39be3e2.png" style="max-width: 100%;">
  </p>
  <p>
   再看这个返回结果 ，好像有点不对劲，以前的不都是直接把结果字符串打印出来了吗，这里咋没打印，
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/9abd07883180f54c11941bae2d71b9d6.png" style="max-width: 100%;">
  </p>
  <p>
   根据前面的跟栈我们知道，他会调用下toString，那么，这里我们也把toString补上去看看：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/627ac566dfe267c20de2d4fe4248f9a2.png" style="max-width: 100%;">
  </p>
  <p>
   牛逼，终于出来了。
  </p>
  <p>
   完整代码
  </p>
  <pre class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>danmaku</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span></span><span class="token class-name">AndroidEmulator</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span></span><span class="token class-name">Module</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span>linux<span class="token punctuation">.</span>android<span class="token punctuation">.</span></span><span class="token class-name">AndroidEmulatorBuilder</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span>linux<span class="token punctuation">.</span>android<span class="token punctuation">.</span></span><span class="token class-name">AndroidResolver</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span>linux<span class="token punctuation">.</span>android<span class="token punctuation">.</span>dvm<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span>linux<span class="token punctuation">.</span>android<span class="token punctuation">.</span>dvm<span class="token punctuation">.</span>array<span class="token punctuation">.</span></span><span class="token class-name">ByteArray</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span>memory<span class="token punctuation">.</span></span><span class="token class-name">Memory</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">File</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">UnsupportedEncodingException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">TreeMap</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> bili <span class="token keyword">extends</span> <span class="token class-name">AbstractJni</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AndroidEmulator</span> emulator<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">VM</span> vm<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Module</span> <span class="token keyword">module</span><span class="token punctuation">;</span>

    <span class="token function">bili</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 创建模拟器实例,进程名建议依照实际进程名填写，可以规避针对进程名的校验</span>
        emulator <span class="token operator">=</span> <span class="token class-name">AndroidEmulatorBuilder</span><span class="token punctuation">.</span><span class="token function">for32Bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setProcessName</span><span class="token punctuation">(</span><span class="token string">"com.bilibili.app"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取模拟器的内存操作接口</span>
        <span class="token keyword">final</span> <span class="token class-name">Memory</span> memory <span class="token operator">=</span> emulator<span class="token punctuation">.</span><span class="token function">getMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        emulator<span class="token punctuation">.</span><span class="token function">getSyscallHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setEnableThreadDispatcher</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置系统类库解析</span>
        memory<span class="token punctuation">.</span><span class="token function">setLibraryResolver</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AndroidResolver</span><span class="token punctuation">(</span><span class="token number">23</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建Android虚拟机,传入APK，Unidbg可以替我们做部分签名校验的工作</span>
        vm <span class="token operator">=</span> emulator<span class="token punctuation">.</span><span class="token function">createDalvikVM</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"unidbg-android\\src\\test\\java\\com\\danmaku\\bilibili.apk"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 加载目标SO</span>
        <span class="token class-name">DalvikModule</span> dm <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"unidbg-android\\src\\test\\java\\com\\danmaku\\libbili.so"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 加载so到虚拟内存</span>
        <span class="token comment">//获取本SO模块的句柄,后续需要用它</span>
        <span class="token keyword">module</span> <span class="token operator">=</span> dm<span class="token punctuation">.</span><span class="token function">getModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        vm<span class="token punctuation">.</span><span class="token function">setJni</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置JNI</span>
        vm<span class="token punctuation">.</span><span class="token function">setVerbose</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 打印日志</span>

        dm<span class="token punctuation">.</span><span class="token function">callJNI_OnLoad</span><span class="token punctuation">(</span>emulator<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用JNI OnLoad</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        bili test <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">bili</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>test<span class="token punctuation">.</span><span class="token function">getSign</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">callBooleanMethod</span><span class="token punctuation">(</span><span class="token class-name">BaseVM</span> vm<span class="token punctuation">,</span> <span class="token class-name">DvmObject</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> dvmObject<span class="token punctuation">,</span> <span class="token class-name">String</span> signature<span class="token punctuation">,</span> <span class="token class-name">VarArg</span> varArg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"java/util/Map-&gt;isEmpty()Z"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>signature<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">TreeMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> treeMap <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">TreeMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>dvmObject<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> treeMap<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">callBooleanMethod</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> dvmObject<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> varArg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">DvmObject</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">callObjectMethod</span><span class="token punctuation">(</span><span class="token class-name">BaseVM</span> vm<span class="token punctuation">,</span> <span class="token class-name">DvmObject</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> dvmObject<span class="token punctuation">,</span> <span class="token class-name">String</span> signature<span class="token punctuation">,</span> <span class="token class-name">VarArg</span> varArg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>signature<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token string">"java/util/Map-&gt;get(Ljava/lang/Object;)Ljava/lang/Object;"</span><span class="token operator">:</span>
                <span class="token class-name">StringObject</span> keyobject <span class="token operator">=</span> varArg<span class="token punctuation">.</span><span class="token function">getObjectArg</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> key <span class="token operator">=</span> keyobject<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">TreeMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> treeMap <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">TreeMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>dvmObject<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> value <span class="token operator">=</span> treeMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">StringObject</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">callObjectMethod</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> dvmObject<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> varArg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">DvmObject</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">callStaticObjectMethod</span><span class="token punctuation">(</span><span class="token class-name">BaseVM</span> vm<span class="token punctuation">,</span> <span class="token class-name">DvmClass</span> dvmClass<span class="token punctuation">,</span> <span class="token class-name">String</span> signature<span class="token punctuation">,</span> <span class="token class-name">VarArg</span> varArg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>signature<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token string">"com/bilibili/nativelibrary/SignedQuery-&gt;r(Ljava/util/Map;)Ljava/lang/String;"</span><span class="token operator">:</span><span class="token punctuation">{</span>
                <span class="token class-name">DvmObject</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> mapObject <span class="token operator">=</span> varArg<span class="token punctuation">.</span><span class="token function">getObjectArg</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">TreeMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> mymap <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">TreeMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> mapObject<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> result <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">r</span><span class="token punctuation">(</span>mymap<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">StringObject</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">callStaticObjectMethod</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> dvmClass<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> varArg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">DvmObject</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">newObject</span><span class="token punctuation">(</span><span class="token class-name">BaseVM</span> vm<span class="token punctuation">,</span> <span class="token class-name">DvmClass</span> dvmClass<span class="token punctuation">,</span> <span class="token class-name">String</span> signature<span class="token punctuation">,</span> <span class="token class-name">VarArg</span> varArg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>signature<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token string">"com/bilibili/nativelibrary/SignedQuery-&gt;&lt;init&gt;(Ljava/lang/String;Ljava/lang/String;)V"</span><span class="token operator">:</span>
                <span class="token class-name">StringObject</span> stringObject1 <span class="token operator">=</span> varArg<span class="token punctuation">.</span><span class="token function">getObjectArg</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">StringObject</span> stringObject2 <span class="token operator">=</span> varArg<span class="token punctuation">.</span><span class="token function">getObjectArg</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> str1 <span class="token operator">=</span> stringObject1<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> str2 <span class="token operator">=</span> stringObject2<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> vm<span class="token punctuation">.</span><span class="token function">resolveClass</span><span class="token punctuation">(</span><span class="token string">"com/bilibili/nativelibrary/SignedQuery"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newObject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SignedQuery</span><span class="token punctuation">(</span>str1<span class="token punctuation">,</span> str2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">newObject</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> dvmClass<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> varArg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SignedQuery</span> <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">String</span> a<span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">String</span> b<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">SignedQuery</span><span class="token punctuation">(</span><span class="token class-name">String</span> str<span class="token punctuation">,</span> <span class="token class-name">String</span> str2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>a <span class="token operator">=</span> str<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>b <span class="token operator">=</span> str2<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> str <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>str <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>b <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> str<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>a <span class="token operator">+</span> <span class="token string">"&amp;sign="</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>b<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getSign</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">getJNIEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 这里传入treemap</span>
        <span class="token class-name">TreeMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> keymap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"ad_extra"</span><span class="token punctuation">,</span> <span class="token string">"E0DA3BAB712CAB3902D558CFD4FEB865AB1563B7D61A4A57D02854BB9A4512C5E4737CA15664C505F3E63B954BB68837690B81FE77B2E7EB578F3E3D7C528439725348FE86527D7415BA2267FCCD2C95895AE80E69A960812FE60BC477171DAD34472EC31D010940A2876CADE887EA26FD5FBFB718D09F193D14732E54E42EB329EBF61CA33DE876AF24C03A7B9E89DB9C831AF6D1CB8B3B883AA3856AF08424AD8913BDE1207A5C2E010E23274ECCA7BC44814561E236325F0C4D2FFE069D2F9BF5B40411A3D26D0BB864EC87713391FAE1197ACFD402D6D386B035BF04995C280989B7305964F179E149067FA864F66FA856EFBD3C8A005F92F1D7C93D82BC8C5B4804DC54154F34E5820B2A481C3F33EEDDB4323C142359920F60686D95E715E30894676AEDE6933A31092E98F979157D267D580D056C3EDDD31934E762D7354A2E1959AAD44D1DDAF094B6E8F38C5450C6A164BD40AF2C3FB2E44BD8E0F914C7BA0FBA4FA553A2A1291BAF9E87FC528C2D53A6B3D3EFEA88F5C359119A31018AD879124BE62B4A4BCFEF98FA5EE1BB5675D9828D1B246A10841CF1F6D1CC1C13C3C11C7E37BCEF93E933395A1FA4D7AEA4CB79DC3ED1EC162C926CFE1157366100A3AF788CF3262DC381B620FB68913694FD332D7D555CD60E3AC54E2F0A5FC2C90530A27721664A64B008FAB0A6"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"appkey"</span><span class="token punctuation">,</span> <span class="token string">"1d8b6e7d45233436"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"autoplay_card"</span><span class="token punctuation">,</span> <span class="token string">"11"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"build"</span><span class="token punctuation">,</span> <span class="token string">"6180500"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"c_locale"</span><span class="token punctuation">,</span> <span class="token string">"zh_CN"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"channel"</span><span class="token punctuation">,</span> <span class="token string">"shenma069"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"column"</span><span class="token punctuation">,</span> <span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"device_name"</span><span class="token punctuation">,</span> <span class="token string">"MI 6"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"device_type"</span><span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"flush"</span><span class="token punctuation">,</span> <span class="token string">"8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"fnval"</span><span class="token punctuation">,</span> <span class="token string">"400"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"fnver"</span><span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"force_host"</span><span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"fourk"</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"guidance"</span><span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"https_url_req"</span><span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"idx"</span><span class="token punctuation">,</span> <span class="token string">"1682561936"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"inline_danmu"</span><span class="token punctuation">,</span> <span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"inline_sound"</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"login_event"</span><span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"mobi_app"</span><span class="token punctuation">,</span> <span class="token string">"android"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"network"</span><span class="token punctuation">,</span> <span class="token string">"wifi"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"open_event"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"platform"</span><span class="token punctuation">,</span> <span class="token string">"android"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"player_net"</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"pull"</span><span class="token punctuation">,</span> <span class="token string">"false"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"qn"</span><span class="token punctuation">,</span> <span class="token string">"32"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"recsys_mode"</span><span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"s_locale"</span><span class="token punctuation">,</span> <span class="token string">"zh_CN"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"splash_id"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"statistics"</span><span class="token punctuation">,</span> <span class="token string">"{\"appId\":1,\"platform\":3,\"version\":\"6.18.0\",\"abtest\":\"\"}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"ts"</span><span class="token punctuation">,</span> <span class="token string">"1612693177"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DvmClass</span> <span class="token class-name">Map</span> <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">resolveClass</span><span class="token punctuation">(</span><span class="token string">"java/util/Map"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DvmClass</span> <span class="token class-name">AbstractMap</span> <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">resolveClass</span><span class="token punctuation">(</span><span class="token string">"java/util/AbstractMap"</span><span class="token punctuation">,</span><span class="token class-name">Map</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DvmObject</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> input_map <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">resolveClass</span><span class="token punctuation">(</span><span class="token string">"java/util/TreeMap"</span><span class="token punctuation">,</span> <span class="token class-name">AbstractMap</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newObject</span><span class="token punctuation">(</span>keymap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">addLocalObject</span><span class="token punctuation">(</span>input_map<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Number</span> number <span class="token operator">=</span>  <span class="token keyword">module</span><span class="token punctuation">.</span><span class="token function">callFunction</span><span class="token punctuation">(</span>emulator<span class="token punctuation">,</span><span class="token number">0x1c97</span><span class="token punctuation">,</span>list<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> result <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span>number<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre>
  <p>
   util:
  </p>
  <pre class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>danmaku</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">UnsupportedEncodingException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">SortedMap</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">TreeMap</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> util <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> f14884c <span class="token operator">=</span> <span class="token string">"0123456789ABCDEF"</span><span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token keyword">char</span> c2<span class="token punctuation">,</span> <span class="token class-name">String</span> str<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>c2 <span class="token operator">&gt;=</span> <span class="token char">'A'</span> <span class="token operator">&amp;&amp;</span> c2 <span class="token operator">&lt;=</span> <span class="token char">'Z'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>c2 <span class="token operator">&gt;=</span> <span class="token char">'a'</span> <span class="token operator">&amp;&amp;</span> c2 <span class="token operator">&lt;=</span> <span class="token char">'z'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token punctuation">(</span>c2 <span class="token operator">&lt;</span> <span class="token char">'0'</span> <span class="token operator">||</span> c2 <span class="token operator">&gt;</span> <span class="token char">'9'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token string">"-_.~"</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>c2<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>str <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> str<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>c2<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">b</span><span class="token punctuation">(</span><span class="token class-name">String</span> str<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">c</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">c</span><span class="token punctuation">(</span><span class="token class-name">String</span> str<span class="token punctuation">,</span> <span class="token class-name">String</span> str2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>str <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">int</span> length <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> i2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>i2 <span class="token operator">&lt;</span> length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> i3 <span class="token operator">=</span> i2<span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>i3 <span class="token operator">&lt;</span> length <span class="token operator">&amp;&amp;</span> <span class="token function">a</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i3<span class="token punctuation">)</span><span class="token punctuation">,</span> str2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                i3<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i3 <span class="token operator">!=</span> length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>sb <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>i3 <span class="token operator">&gt;</span> i2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">CharSequence</span><span class="token punctuation">)</span> str<span class="token punctuation">,</span> i2<span class="token punctuation">,</span> i3<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                i2 <span class="token operator">=</span> i3 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>i2 <span class="token operator">&lt;</span> length <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">a</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i2<span class="token punctuation">)</span><span class="token punctuation">,</span> str2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    i2<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>i3<span class="token punctuation">,</span> i2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">int</span> length2 <span class="token operator">=</span> bytes<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i4 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i4 <span class="token operator">&lt;</span> length2<span class="token punctuation">;</span> i4<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token char">'%'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>f14884c<span class="token punctuation">[</span><span class="token punctuation">(</span>bytes<span class="token punctuation">[</span>i4<span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">240</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>f14884c<span class="token punctuation">[</span>bytes<span class="token punctuation">[</span>i4<span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UnsupportedEncodingException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AssertionError</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>i2 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> str<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">CharSequence</span><span class="token punctuation">)</span> str<span class="token punctuation">,</span> i2<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> sb <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> str <span class="token operator">:</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">r</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> map<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> str<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>map <span class="token keyword">instanceof</span> <span class="token class-name">SortedMap</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> map<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> key <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>key<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token function">b</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> value <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    str <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    str <span class="token operator">=</span> <span class="token function">b</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
                sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"&amp;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">int</span> length <span class="token operator">=</span> sb<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sb<span class="token punctuation">.</span><span class="token function">deleteCharAt</span><span class="token punctuation">(</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span></pre>
  <p>
   欧克。
  </p>
  <h3>
   <a aria-hidden="true" class="anchor" href="#4直接补类" id="user-content-4直接补类">
    <span aria-hidden="true" class="octicon octicon-link">
    </span>
   </a>
   4.直接补类
  </h3>
  <p>
   根据龙哥的博客，说还有另一种补环境的方式，重建类：
  </p>
  <p>
   不再继承abstrctjni和不再用setjni方法，改用vm.setDvmClassFactory(new ProxyClassFactory());
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/7e4bb713ee68691bb106837f39d49b6b.png" style="max-width: 100%;">
  </p>
  <pre class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>danmaku</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span></span><span class="token class-name">AndroidEmulator</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span></span><span class="token class-name">Module</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span>linux<span class="token punctuation">.</span>android<span class="token punctuation">.</span></span><span class="token class-name">AndroidEmulatorBuilder</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span>linux<span class="token punctuation">.</span>android<span class="token punctuation">.</span></span><span class="token class-name">AndroidResolver</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span>linux<span class="token punctuation">.</span>android<span class="token punctuation">.</span>dvm<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span>linux<span class="token punctuation">.</span>android<span class="token punctuation">.</span>dvm<span class="token punctuation">.</span>jni<span class="token punctuation">.</span></span><span class="token class-name">ProxyClassFactory</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span>memory<span class="token punctuation">.</span></span><span class="token class-name">Memory</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">File</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">TreeMap</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> bili2 <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AndroidEmulator</span> emulator<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">VM</span> vm<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Module</span> <span class="token keyword">module</span><span class="token punctuation">;</span>

    <span class="token function">bili2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 创建模拟器实例,进程名建议依照实际进程名填写，可以规避针对进程名的校验</span>
        emulator <span class="token operator">=</span> <span class="token class-name">AndroidEmulatorBuilder</span><span class="token punctuation">.</span><span class="token function">for32Bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setProcessName</span><span class="token punctuation">(</span><span class="token string">"com.bilibili.app"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取模拟器的内存操作接口</span>
        <span class="token keyword">final</span> <span class="token class-name">Memory</span> memory <span class="token operator">=</span> emulator<span class="token punctuation">.</span><span class="token function">getMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        emulator<span class="token punctuation">.</span><span class="token function">getSyscallHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setEnableThreadDispatcher</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置系统类库解析</span>
        memory<span class="token punctuation">.</span><span class="token function">setLibraryResolver</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AndroidResolver</span><span class="token punctuation">(</span><span class="token number">23</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建Android虚拟机,传入APK，Unidbg可以替我们做部分签名校验的工作</span>
        vm <span class="token operator">=</span> emulator<span class="token punctuation">.</span><span class="token function">createDalvikVM</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"unidbg-android\\src\\test\\java\\com\\danmaku\\bilibili.apk"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 加载目标SO</span>
        <span class="token class-name">DalvikModule</span> dm <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"unidbg-android\\src\\test\\java\\com\\danmaku\\libbili.so"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 加载so到虚拟内存</span>
        <span class="token comment">//获取本SO模块的句柄,后续需要用它</span>
        <span class="token keyword">module</span> <span class="token operator">=</span> dm<span class="token punctuation">.</span><span class="token function">getModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        vm.setJni(this); // 设置JNI</span>
        vm<span class="token punctuation">.</span><span class="token function">setDvmClassFactory</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProxyClassFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        vm<span class="token punctuation">.</span><span class="token function">setVerbose</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 打印日志</span>

        dm<span class="token punctuation">.</span><span class="token function">callJNI_OnLoad</span><span class="token punctuation">(</span>emulator<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用JNI OnLoad</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        bili2 test <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">bili2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>test<span class="token punctuation">.</span><span class="token function">getSign</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getSign</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">getJNIEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 这里传入treemap</span>
        <span class="token class-name">TreeMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> keymap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"ad_extra"</span><span class="token punctuation">,</span> <span class="token string">"E0DA3BAB712CAB3902D558CFD4FEB865AB1563B7D61A4A57D02854BB9A4512C5E4737CA15664C505F3E63B954BB68837690B81FE77B2E7EB578F3E3D7C528439725348FE86527D7415BA2267FCCD2C95895AE80E69A960812FE60BC477171DAD34472EC31D010940A2876CADE887EA26FD5FBFB718D09F193D14732E54E42EB329EBF61CA33DE876AF24C03A7B9E89DB9C831AF6D1CB8B3B883AA3856AF08424AD8913BDE1207A5C2E010E23274ECCA7BC44814561E236325F0C4D2FFE069D2F9BF5B40411A3D26D0BB864EC87713391FAE1197ACFD402D6D386B035BF04995C280989B7305964F179E149067FA864F66FA856EFBD3C8A005F92F1D7C93D82BC8C5B4804DC54154F34E5820B2A481C3F33EEDDB4323C142359920F60686D95E715E30894676AEDE6933A31092E98F979157D267D580D056C3EDDD31934E762D7354A2E1959AAD44D1DDAF094B6E8F38C5450C6A164BD40AF2C3FB2E44BD8E0F914C7BA0FBA4FA553A2A1291BAF9E87FC528C2D53A6B3D3EFEA88F5C359119A31018AD879124BE62B4A4BCFEF98FA5EE1BB5675D9828D1B246A10841CF1F6D1CC1C13C3C11C7E37BCEF93E933395A1FA4D7AEA4CB79DC3ED1EC162C926CFE1157366100A3AF788CF3262DC381B620FB68913694FD332D7D555CD60E3AC54E2F0A5FC2C90530A27721664A64B008FAB0A6"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"appkey"</span><span class="token punctuation">,</span> <span class="token string">"1d8b6e7d45233436"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"autoplay_card"</span><span class="token punctuation">,</span> <span class="token string">"11"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"build"</span><span class="token punctuation">,</span> <span class="token string">"6180500"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"c_locale"</span><span class="token punctuation">,</span> <span class="token string">"zh_CN"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"channel"</span><span class="token punctuation">,</span> <span class="token string">"shenma069"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"column"</span><span class="token punctuation">,</span> <span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"device_name"</span><span class="token punctuation">,</span> <span class="token string">"MI 6"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"device_type"</span><span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"flush"</span><span class="token punctuation">,</span> <span class="token string">"8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"fnval"</span><span class="token punctuation">,</span> <span class="token string">"400"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"fnver"</span><span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"force_host"</span><span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"fourk"</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"guidance"</span><span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"https_url_req"</span><span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"idx"</span><span class="token punctuation">,</span> <span class="token string">"1682561936"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"inline_danmu"</span><span class="token punctuation">,</span> <span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"inline_sound"</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"login_event"</span><span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"mobi_app"</span><span class="token punctuation">,</span> <span class="token string">"android"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"network"</span><span class="token punctuation">,</span> <span class="token string">"wifi"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"open_event"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"platform"</span><span class="token punctuation">,</span> <span class="token string">"android"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"player_net"</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"pull"</span><span class="token punctuation">,</span> <span class="token string">"false"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"qn"</span><span class="token punctuation">,</span> <span class="token string">"32"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"recsys_mode"</span><span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"s_locale"</span><span class="token punctuation">,</span> <span class="token string">"zh_CN"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"splash_id"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"statistics"</span><span class="token punctuation">,</span> <span class="token string">"{\"appId\":1,\"platform\":3,\"version\":\"6.18.0\",\"abtest\":\"\"}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keymap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"ts"</span><span class="token punctuation">,</span> <span class="token string">"1612693177"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DvmClass</span> <span class="token class-name">Map</span> <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">resolveClass</span><span class="token punctuation">(</span><span class="token string">"java/util/Map"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DvmClass</span> <span class="token class-name">AbstractMap</span> <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">resolveClass</span><span class="token punctuation">(</span><span class="token string">"java/util/AbstractMap"</span><span class="token punctuation">,</span><span class="token class-name">Map</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DvmObject</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> input_map <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">resolveClass</span><span class="token punctuation">(</span><span class="token string">"java/util/TreeMap"</span><span class="token punctuation">,</span> <span class="token class-name">AbstractMap</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newObject</span><span class="token punctuation">(</span>keymap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">addLocalObject</span><span class="token punctuation">(</span>input_map<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Number</span> number <span class="token operator">=</span>  <span class="token keyword">module</span><span class="token punctuation">.</span><span class="token function">callFunction</span><span class="token punctuation">(</span>emulator<span class="token punctuation">,</span><span class="token number">0x1c97</span><span class="token punctuation">,</span>list<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> result <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span>number<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre>
  <p>
   直接运行：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/bb3b02316404700c55693c30085c96d1.png" style="max-width: 100%;">
  </p>
  <p>
   把需要的类全都放进去，SignedQuery、ContainerUtils、cv
  </p>
  <p>
   记得把signedQuery放到他该有的类，其他就随意了，他会自己在同级目录查找，ok，直接出结果。这里龙哥把ContainerUtils、cv类都单独创建了该有的类名前缀，我这里就没有了，一样出结果，感觉还是归类在一起好点
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/af60d714292e333d37843a754305569e.png" style="max-width: 100%;">
  </p>
  <p>
   这样的效果就是，不需要去手动补需要的环境了（因为需要的环境类整个都有了）
  </p>
  <h2>
   <a aria-hidden="true" class="anchor" href="#知识点总结" id="user-content-知识点总结">
    <span aria-hidden="true" class="octicon octicon-link">
    </span>
   </a>
   知识点总结
  </h2>
  <p>
   1.treemap需要注意下，在unidbg里需要继承map，abstractmap
  </p>
  <p>
   2.varArg.getObjectArg(0)可以获取该方法的参数，0，指第一个，1指第二个
  </p>
  <blockquote>
   <p>
    StringObject stringObject1&nbsp;= varArg.getObjectArg(0);
   </p>
   <p>
    StringObject stringObject2&nbsp;= varArg.getObjectArg(1);
   </p>
   <p>
    String str1&nbsp;= stringObject1.getValue();
   </p>
   <p>
    String str2&nbsp;= stringObject2.getValue();
   </p>
  </blockquote>
  <p>
   3.unidbg有新的写法，不继承abstractjni，setjni的地方改成vm.setDvmClassFactory(new ProxyClassFactory());
  </p>
  <p>
   这种方法适合java环境太多的情况，不用一个一个手动补，直接用java用到的类
  </p>
  <script src="prism.js">
  </script>
  <script>
   window.onscroll = function() {
    document.getElementById('catalogue').style.top = window.pageYOffset + 'px';
}
  </script>
 </body>
</html>