<html>
 <head>
  <title>
   app安全之安卓native层安全分析（七）：unidbg自尝试某潮流app+dvmObject[]处理
  </title>
  <link data-noprefix="" href="prism.css" rel="stylesheet">
  <style>
   a{
    color: black;
    text-decoration: none;
}
a:hover{
    color: blue;
}
ul{
    list-style: none;
}
#catalogue {
    top: 10px;
    right: 10px;
    padding: 5px 10px;
    position: absolute;
    border: 1px solid blue;
    background-color: white;
}
  </style>
 </head>
 <body>
  <h1>
   <a>
    app安全之安卓native层安全分析（七）：unidbg自尝试某潮流app+dvmObject[]处理
   </a>
  </h1>
  <ul id="catalogue">
   <li title="返回目录">
    <a href="/html">
     返回目录
    </a>
   </li>
   <li title="前言">
    <a href="#user-content-前言">
     前言
    </a>
   </li>
   <li title="分析">
    <a href="#user-content-分析">
     分析
    </a>
   </li>
   <ul>
    <li title="1.抓包">
     <a href="#user-content-1抓包">
      1.抓包
     </a>
    </li>
    <li title="2.调试找参数">
     <a href="#user-content-2调试找参数">
      2.调试找参数
     </a>
    </li>
    <li title="3.ida查看：">
     <a href="#user-content-3ida查看：">
      3.ida查看：
     </a>
    </li>
   </ul>
   <li title="调试">
    <a href="#user-content-调试">
     调试
    </a>
   </li>
   <ul>
    <li title="1.搭架子">
     <a href="#user-content-1搭架子">
      1.搭架子
     </a>
    </li>
    <li title="2.调用\&amp;补环境">
     <a href="#user-content-2调用\&amp;补环境">
      2.调用\&amp;补环境
     </a>
    </li>
    <li title="3.结果修复">
     <a href="#user-content-3结果修复">
      3.结果修复
     </a>
    </li>
    <li title="4.另一种调用">
     <a href="#user-content-4另一种调用">
      4.另一种调用
     </a>
    </li>
    <li title="5.验证是否可用">
     <a href="#user-content-5验证是否可用">
      5.验证是否可用
     </a>
    </li>
   </ul>
   <li title="结语">
    <a href="#user-content-结语">
     结语
    </a>
   </li>
  </ul>
  <h2>
   <a aria-hidden="true" class="anchor" href="#前言" id="user-content-前言">
    <span aria-hidden="true" class="octicon octicon-link">
    </span>
   </a>
   前言
  </h2>
  <p>
   跟着龙哥搞了几次unidbg了，这次也自己尝试用来分析下某潮流app了。
  </p>
  <h2>
   <a aria-hidden="true" class="anchor" href="#分析" id="user-content-分析">
    <span aria-hidden="true" class="octicon octicon-link">
    </span>
   </a>
   分析
  </h2>
  <h3>
   <a aria-hidden="true" class="anchor" href="#1抓包" id="user-content-1抓包">
    <span aria-hidden="true" class="octicon octicon-link">
    </span>
   </a>
   1.抓包
  </h3>
  <p>
   先抓个包
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/092c5b7f6036800f48f9260261f87dfd.png" style="max-width: 100%;">
  </p>
  <p>
   我们要搞的就是这个sign-v1了。
  </p>
  <h3>
   <a aria-hidden="true" class="anchor" href="#2调试找参数" id="user-content-2调试找参数">
    <span aria-hidden="true" class="octicon octicon-link">
    </span>
   </a>
   2.调试找参数
  </h3>
  <p>
   jadx一顿分析，一搜：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/20a9fdbe57435aff480efa16cd66d279.png" style="max-width: 100%;">
  </p>
  <p>
   搜出来还不少，往下翻，找找一些特征，很快找到这里
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/43575bdc2e75c2ea82bf336a58820d8d.png" style="max-width: 100%;">
  </p>
  <p>
   点进去
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/5efb47b06c51a36c5de1c019f50bfef9.png" style="max-width: 100%;">
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/5094d1fc5c4b8ea12db9f4de00d7ca68.png" style="max-width: 100%;">
  </p>
  <p>
   ok，用objection hook之后，发现不是这个方法，但是确实是这个方法所在的类的b方法：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/8f2b7f7f62473010509dc1111a9f4870.png" style="max-width: 100%;">
  </p>
  <p>
   然后调用了这个getsign，getsign就在下面
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/9ee3502919924cb50c65e8b42a8dff37.png" style="max-width: 100%;">
  </p>
  <p>
   再来hook下这两个方法：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/506a4bec1639363fd4785ef45529617f.png" style="max-width: 100%;">
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/22fa8ca085ff624065398a0a3e9fe5bc.png" style="max-width: 100%;">
  </p>
  <p>
   基本确定，就是这里了，抓包工具也对比就是这里：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/76bcf2263a4a9f6b13c26c257b9b6806.png" style="max-width: 100%;">
  </p>
  <h3>
   <a aria-hidden="true" class="anchor" href="#3ida查看" id="user-content-3ida查看">
    <span aria-hidden="true" class="octicon octicon-link">
    </span>
   </a>
   3.ida查看：
  </h3>
  <p>
   打开ida看看，发现是静态绑定的
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/742886925602a7a6103e08440d645941.png" style="max-width: 100%;">
  </p>
  <p>
   可以的，感觉很简单
  </p>
  <h2>
   <a aria-hidden="true" class="anchor" href="#调试" id="user-content-调试">
    <span aria-hidden="true" class="octicon octicon-link">
    </span>
   </a>
   调试
  </h2>
  <h3>
   <a aria-hidden="true" class="anchor" href="#1搭架子" id="user-content-1搭架子">
    <span aria-hidden="true" class="octicon octicon-link">
    </span>
   </a>
   1.搭架子
  </h3>
  <p>
   首先搭一下架子，然后既然他不是动态注册的，那就可以不用设置调用jni_load了：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/ef57305623c475b94ba2582d68a1a5d6.png" style="max-width: 100%;">
  </p>
  <p>
   看着没毛病，直接调用吧
  </p>
  <h3>
   <a aria-hidden="true" class="anchor" href="#2调用补环境" id="user-content-2调用补环境">
    <span aria-hidden="true" class="octicon octicon-link">
    </span>
   </a>
   2.调用&amp;补环境
  </h3>
  <p>
   废话不多说，直接拿着hook到的参数拿来调用：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/7dd8d9ccd56c8977a8fdc5f51dcbe378.png" style="max-width: 100%;">
  </p>
  <p>
   看下，这个ach是啥，ok，看样子就是随机生成一个16位的字符串
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/9ab65c6f6ee1e94c52d70b01e05d01f9.png" style="max-width: 100%;">
  </p>
  <p>
   补一下环境
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/d41b59ce3188addab0204d595844aec3.png" style="max-width: 100%;">
  </p>
  <p>
   继续看
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/b37ac83b563d14b282e3a94d0a6f37bf.png" style="max-width: 100%;">
  </p>
  <p>
   原来就是把这几个加起来
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/87fa88b2209866ff68632057daec4801.png" style="max-width: 100%;">
  </p>
  <p>
   补一下：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/dcfd37e84ca284d38dcfca070bdc476b.png" style="max-width: 100%;">
  </p>
  <p>
   结果已经出来了。但是打印的是一个dvmobject对象。很奇怪了。再看看hook的结果：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/17d166030a7ad95d0d6857a3d5aca001.png" style="max-width: 100%;">
  </p>
  <p>
   其实是个有三个元素的字符串数组。所以他应该是对象
  </p>
  <p>
   断点调试一下
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/eb9c7fcaec14956f626dcb27e757e7bb.png" style="max-width: 100%;">
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/9f133994be7bdeaea3814d0d9bd3cb2a.png" style="max-width: 100%;">
  </p>
  <p>
   结果这么写会报错：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/37d14d19da8cd89cf318595d3ce9a6b1.png" style="max-width: 100%;">
  </p>
  <p>
   强转string[]也不行，就很尴尬
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/13ce4938dcc230879310bc7f90a55723.png" style="max-width: 100%;">
  </p>
  <h3>
   <a aria-hidden="true" class="anchor" href="#3结果修复" id="user-content-3结果修复">
    <span aria-hidden="true" class="octicon octicon-link">
    </span>
   </a>
   3.结果修复
  </h3>
  <p>
   问了一下unidbg的大佬，应该这么写：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/68a52a61d7a10ef609f54585c8b04429.png" style="max-width: 100%;">
  </p>
  <p>
   这么写就可以了。
  </p>
  <pre class="language-java"><span class="token class-name">DvmObject</span><span class="token punctuation">[</span><span class="token punctuation">]</span> result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">DvmObject</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> vm<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span>number<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">String</span> sign <span class="token operator">=</span> result<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
  <h3>
   <a aria-hidden="true" class="anchor" href="#4另一种调用" id="user-content-4另一种调用">
    <span aria-hidden="true" class="octicon octicon-link">
    </span>
   </a>
   4.另一种调用
  </h3>
  <p>
   首先，我们都知道有，地址调用，符号调用，如下：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/7feb857dfa105a041005b617b46060ca.png" style="max-width: 100%;">
  </p>
  <p>
   其实，根据我问的unidbg玩的6的大佬，还有另一种调用
  </p>
  <p>
   这么写，代码量减少了很多。
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/e93fc3e0126625901b387b944d4fcf9b.png" style="max-width: 100%;">
  </p>
  <p>
   但是有个问题就是，那个network类，需要在构造方法里定义一下：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/0e764d29016379d8bac297a73ab22359.png" style="max-width: 100%;">
  </p>
  <p>
   另外，这个方法的签名，怎么拿到，用jadx的smali代码查看：
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/1e66ee8d17baf15426dea372bd4e9f8c.png" style="max-width: 100%;">
  </p>
  <p>
   这里就直接有了，复制过去就可以用，注意最后的【；】也要带上。
  </p>
  <h3>
   <a aria-hidden="true" class="anchor" href="#5验证是否可用" id="user-content-5验证是否可用">
    <span aria-hidden="true" class="octicon octicon-link">
    </span>
   </a>
   5.验证是否可用
  </h3>
  <p>
   试试刚才的两种调用的结果，能不能拿来请求，然后正常返回呢？
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/d3627edc828062be79c8496bc24072f6.png" style="max-width: 100%;">
  </p>
  <p>
   <img alt="" src="https://img-blog.csdnimg.cn/img_convert/4cad50a75fd26f43b3989d0744a515ad.png" style="max-width: 100%;">
  </p>
  <p>
   ok，两个都可以 ，说明主动调用，整个过程，很成功
  </p>
  <h2>
   <a aria-hidden="true" class="anchor" href="#结语" id="user-content-结语">
    <span aria-hidden="true" class="octicon octicon-link">
    </span>
   </a>
   结语
  </h2>
  <p>
   整个过程很轻松加愉快。除了最后的dvmObject数组的转换，其他没啥需要记录的。
  </p>
  <script src="prism.js">
  </script>
  <script>
   window.onscroll = function() {
    document.getElementById('catalogue').style.top = window.pageYOffset + 'px';
}
  </script>
 </body>
</html>