<html>
 <head>
  <title>
   移动安全分析流程
  </title>
  <link data-noprefix="" href="prism.css" rel="stylesheet">
  <style>
   a{
    color: black;
    text-decoration: none;
}
a:hover{
    color: blue;
}
ul{
    list-style: none;
}
#catalogue {
    top: 10px;
    right: 10px;
    padding: 5px 10px;
    position: absolute;
    border: 1px solid blue;
    background-color: white;
}
  </style>
 </head>
 <body>
  <h1>
   <a>
    移动安全分析流程
   </a>
  </h1>
  <ul id="catalogue">
   <li title="返回目录">
    <a href="/html">
     返回目录
    </a>
   </li>
   <li title="声明">
    <a href="#user-content-声明">
     声明
    </a>
   </li>
   <li title="前言">
    <a href="#user-content-前言">
     前言
    </a>
   </li>
   <li title="抓包">
    <a href="#user-content-抓包">
     抓包
    </a>
   </li>
   <li title="目标点定位的思路">
    <a href="#user-content-目标点定位的思路">
     目标点定位的思路
    </a>
   </li>
   <li title="调试">
    <a href="#user-content-调试">
     调试
    </a>
   </li>
   <li title="加密协议实现">
    <a href="#user-content-加密协议实现">
     加密协议实现
    </a>
   </li>
   <ul>
    <li title="1.确定是什么加密算法（并不通用，需要结合实际）">
     <a href="#user-content-1确定是什么加密算法（并不通用，需要结合实际）">
      1.确定是什么加密算法（并不通用，需要结合实际）
     </a>
    </li>
    <li title="2.判断是否是标准的加密算法，给一个固定的入参，与标准的算法对照加密结果">
     <a href="#user-content-2判断是否是标准的加密算法，给一个固定的入参，与标准的算法对照加密结果">
      2.判断是否是标准的加密算法，给一个固定的入参，与标准的算法对照加密结果
     </a>
    </li>
    <li title="3.实现协议">
     <a href="#user-content-3实现协议">
      3.实现协议
     </a>
    </li>
   </ul>
   <li title="风控对抗">
    <a href="#user-content-风控对抗">
     风控对抗
    </a>
   </li>
   <li title="结语">
    <a href="#user-content-结语">
     结语
    </a>
   </li>
  </ul>
  <h2>
   <a aria-hidden="true" class="anchor" href="#声明" id="user-content-声明">
    <span aria-hidden="true" class="octicon octicon-link">
    </span>
   </a>
   声明
  </h2>
  <p>
   以下只是搬运下我公众号的东西。很早就发过了。原帖地址：
  </p>
  <p>
   <a href="https://mp.weixin.qq.com/s/wcx-lK2y0HA-Cx5klV1OfA" rel="nofollow" title="移动安全逆向分析流程">
    移动安全逆向分析流程
   </a>
  </p>
  <p>
   已经发公众号的为什么还发csdn
   <br>
   有的圈内朋友，不经过我的允许，删减摘录我公众号的内容，这里就不提谁了，心里清楚，还能获得一些关注和流量。很无语，所以我还不如自己也发发。【猛男落泪】
  </p>
  <h2>
   <a aria-hidden="true" class="anchor" href="#前言" id="user-content-前言">
    <span aria-hidden="true" class="octicon octicon-link">
    </span>
   </a>
   前言
  </h2>
  <p>
   前面整理了一套技能树1.0版，这次整理下逆向思路，我们拿到一个app，常规的分析流程
  </p>
  <h2>
   <a aria-hidden="true" class="anchor" href="#抓包" id="user-content-抓包">
    <span aria-hidden="true" class="octicon octicon-link">
    </span>
   </a>
   抓包
  </h2>
  <p>
   第一大问题就是抓包，如果包都抓不到，那基本就没法进一步入手了
  </p>
  <p>
   而现在的app，稍微有点安全意识的，都会防抓包，并且安卓7.0版本开始也自带了安全等级，不再信任用户安装的证书，只信任系统证书，以及种种类似的情况，这种我们怎么处理呢？就得具体问题具体分析了
  </p>
  <pre><code>1.系统代理检测：charles+VPN(postern、drony、小黄鸟)
</code></pre>
  <h2>
   <a aria-hidden="true" class="anchor" href="#目标点定位的思路" id="user-content-目标点定位的思路">
    <span aria-hidden="true" class="octicon octicon-link">
    </span>
   </a>
   目标点定位的思路
  </h2>
  <p>
   抓到包以后，拿到了接口，以及加密参数，怎么定位这个加密参数生成呢
  </p>
  <p>
   1.看请求参数，搜索想要查看的特殊字段（并不推荐，但是确实能解决50-60%的app）
  </p>
  <p>
   2.objection 列出所有的类，hook全部，然后看关键点的时候哪些类被调用了
  </p>
  <p>
   3.利用dumpsys window 或者activity看当前的activity（mt管理器也可以记录activity），进到里面找逻辑，如果逻辑代码太多则不适用
  </p>
  <p>
   4.观察各个接口的请求参数，是否都有一样的请求体结构（换句话说就是看这些请求参数的键名）是不是一样的，如果一样，按照开发逻辑理念，一定有一个通用的模板加密类，搜一个加密字段，找到这个加密类，查找用例，或者用objection跟踪，打印调用栈
  </p>
  <p>
   5.hook 通用的加密算法，打印调用栈
  </p>
  <p>
   6.hook 网络库okhttp，request等的（以OkHttpLogger-Frida库为首的）
  </p>
  <p>
   7.hook hashmap的put方法，大部分的请求参数基本都用的hashmap封装请求体，hook put方法，打印调用栈，则可以找到（并不100%通用）
  </p>
  <p>
   8.hook string类的getBytes等的常用方法或者转Json的方法
  </p>
  <p>
   9.hook Byte类的toString等的常用方法或者转Json的方法
  </p>
  <p>
   10.hook Toast类，主流开发习惯，提示弹窗都用的这个类，hook它，看调用栈
  </p>
  <p>
   11.关闭网络，再发起需要操作的目标接口，看报错提示，利用报错提示找调用栈，实际操作时，大部分情况跟思路10重合
  </p>
  <p>
   12.用frida hook 类android.view.View，点击哪里hook哪里的方法，打印调用栈
  </p>
  <p>
   13.hook Log类，按照开发逻辑，开发人员会在开发的时候会在一个阶段里用log打印输出日志看逻辑，hook log打印调用栈，有时候有奇效
  </p>
  <p>
   14.有的app会检测返回值的格式，并解析输出显示，看是否有通用解析类，hook它，如果hook不上（或者找不到这种类），则用抓包工具修改返回值，然后看解析逻辑（不常用）
  </p>
  <p>
   以上方法也无法保证通用，比如也有反调试调用栈，使其打印不到核心调用流程或者直接返回空调用栈，这种就得针对处理了
  </p>
  <blockquote>
   <p>
    GDA 、jeb、jadx，混着用，别只用jadx，有时候jadx解析并不好，看不到逻辑
   </p>
   <p>
    比如某wtoken，用jeb可以直接看到一些逻辑，jadx的那个部分解析失败
   </p>
  </blockquote>
  <h2>
   <a aria-hidden="true" class="anchor" href="#调试" id="user-content-调试">
    <span aria-hidden="true" class="octicon octicon-link">
    </span>
   </a>
   调试
  </h2>
  <p>
   当定位到加密参数生成逻辑的时候，准备调试
  </p>
  <p>
   一般用objection跟踪类，看调用栈，结合源码，写frida脚本调试，如果在frida逻辑里能hook或者主动调用实现，此步结束
  </p>
  <p>
   目前来看，到这一步，基本都会遇到frida反调试，frida直接用不了，有时候换用lsposed，会有奇效，如果还不行，这就需要去对抗检测了，三两句就说不清楚了，感兴趣可以联系我。
  </p>
  <h2>
   <a aria-hidden="true" class="anchor" href="#加密协议实现" id="user-content-加密协议实现">
    <span aria-hidden="true" class="octicon octicon-link">
    </span>
   </a>
   加密协议实现
  </h2>
  <p>
   调试完感觉能行得通之后，开始实现加密逻辑
  </p>
  <h3>
   <a aria-hidden="true" class="anchor" href="#1确定是什么加密算法并不通用需要结合实际" id="user-content-1确定是什么加密算法并不通用需要结合实际">
    <span aria-hidden="true" class="octicon octicon-link">
    </span>
   </a>
   1.确定是什么加密算法（并不通用，需要结合实际）
  </h3>
  <pre><code>32位，一般是md5
</code></pre>
  <p>
   这里的加密算法，推荐看Q佬的文章
  </p>
  <h3>
   <a aria-hidden="true" class="anchor" href="#2判断是否是标准的加密算法给一个固定的入参与标准的算法对照加密结果" id="user-content-2判断是否是标准的加密算法给一个固定的入参与标准的算法对照加密结果">
    <span aria-hidden="true" class="octicon octicon-link">
    </span>
   </a>
   2.判断是否是标准的加密算法，给一个固定的入参，与标准的算法对照加密结果
  </h3>
  <h3>
   <a aria-hidden="true" class="anchor" href="#3实现协议" id="user-content-3实现协议">
    <span aria-hidden="true" class="octicon octicon-link">
    </span>
   </a>
   3.实现协议
  </h3>
  <p>
   这个就需要需要花精力分析，尝试，实在无法实现，可以用unidbg，不要纠结于手段
  </p>
  <h2>
   <a aria-hidden="true" class="anchor" href="#风控对抗" id="user-content-风控对抗">
    <span aria-hidden="true" class="octicon octicon-link">
    </span>
   </a>
   风控对抗
  </h2>
  <p>
   当以上步骤你都走完后，请求几次，发现确实能拿数据，于是你非常开心的部署并跑起来，结果批量跑没多久，就各种异常返回，滑块，403啥的也跟着来了，这时候你可能就遇到风控了。
  </p>
  <p>
   什么是风控，以下是简单版的，这个不一定齐全也不一定对，后面有空再单独搞个专题文章介绍风控的
  </p>
  <pre><code>手机品牌、型号、壁纸、上网模式、wifi名等上百个基本的设备参数
</code></pre>
  <p>
   结合以上信息，传到服务器，服务端收集到用AI推演出用户画像，行为习惯，判定风险等级，然后给定设备/账号限制
  </p>
  <p>
   如果等级低，则出滑块，不返回数据或者返回异常，提示实名认证，比如某国外社交app，需要人脸认证、身份证、手机号码验证
  </p>
  <p>
   风控这种东西怎么对抗呢，这个就真的难说了，只能花时间测试并针对调整了
  </p>
  <h2>
   <a aria-hidden="true" class="anchor" href="#结语" id="user-content-结语">
    <span aria-hidden="true" class="octicon octicon-link">
    </span>
   </a>
   结语
  </h2>
  <p>
   以上流程或者思路，并不一定对，只是我个人的经验分享而已，如果对您有帮助，那我挺开心的
  </p>
  <p>
   加我微信：
   <strong>
    geekbyte
   </strong>
   ，商务合作或者技术交流，以及小白技术路线推荐，技能提升进阶课程、书推荐
  </p>
  <script src="prism.js">
  </script>
  <script>
   window.onscroll = function() {
    document.getElementById('catalogue').style.top = window.pageYOffset + 'px';
}
  </script>
 </body>
</html>